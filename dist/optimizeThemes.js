"use strict";
/**
 * Copyright Â© Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = require("path");
const createMinifier_1 = require("./createMinifier");
const magentoFS_1 = require("./magentoFS");
const requireConfig_1 = require("./requireConfig");
const traceAMDDependencies_1 = require("./traceAMDDependencies");
const computeDepsForBundle_1 = require("./computeDepsForBundle");
const createBundleFromDeps_1 = require("./createBundleFromDeps");
const fsPromises_1 = require("./fsPromises");
const flatten_1 = require("./flatten");
const cliTask_1 = require("./cliTask");
const BalerError_1 = require("./BalerError");
const BALER_META_DIR = 'balerbundles';
/**
 * @summary Optimize all eligible themes in a Magento 2 store
 */
async function optimizeThemes(magentoRoot, store, themesToOptimize) {
    // Spins up a worker pool, so we only want to do it once, not per-theme
    const minifier = createMinifier_1.createMinifier();
    const pendingThemeResults = themesToOptimize.map(async (themeID) => {
        const theme = getThemeByID(themeID, store.components.themes);
        throwOnDisallowedTheme(theme);
        try {
            const result = await optimizeTheme(magentoRoot, store, theme, minifier);
            return { themeID, success: true, result };
        }
        catch (error) {
            return { themeID, success: false, error };
        }
    });
    const themeResults = await Promise.all(pendingThemeResults);
    minifier.destroy();
    return themeResults;
}
exports.optimizeThemes = optimizeThemes;
/**
 * @summary Optimize a single theme in a Magento 2 store
 */
async function optimizeTheme(magentoRoot, store, theme, minifier) {
    const coreBundleResults = await createCoreBundle(magentoRoot, theme, minifier);
    return coreBundleResults;
}
async function getLayoutBasedDeps(magentoRoot, theme) {
    const enabledModules = await magentoFS_1.getEnabledModules(magentoRoot);
    const { modules, themes } = await magentoFS_1.getComponents(magentoRoot);
    const themeFallback = [];
    let processing = true;
    let currentFallback = theme;
    // Create theme fallback
    while (processing) {
        themeFallback.push(currentFallback);
        if (currentFallback.parentID) {
            currentFallback = themes[currentFallback.parentID];
        }
        else {
            processing = false;
        }
    }
    // Get all layout files
    const layoutFiles = await magentoFS_1.getLayoutFilesEligibleForUseWithTheme(themeFallback, enabledModules, modules);
    console.log(process.cwd());
    // Logging to figure out if a glob is failing on cloud
    console.log(layoutFiles);
    // Create a map of layout file => templateFiles[]
    const layoutToTemplatesMap = new Map();
    // Create a map of layout file => js[]
    const layoutToDepsMap = new Map();
    for (const layoutFile of layoutFiles) {
        let layoutHandle = layoutFile.split('/').pop();
        if (!layoutHandle) {
            continue;
        }
        else {
            layoutHandle = layoutHandle.replace('.xml', '');
        }
        if (!layoutToTemplatesMap.has(layoutHandle)) {
            layoutToTemplatesMap.set(layoutHandle, new Set());
        }
        if (!layoutToDepsMap.has(layoutHandle)) {
            layoutToDepsMap.set(layoutHandle, new Set());
        }
        const templatesSet = layoutToTemplatesMap.get(layoutHandle);
        const templates = await magentoFS_1.getPHTMLFilesFromLayoutHandle(layoutFile, themeFallback, modules);
        for (const template of templates) {
            templatesSet.add(template);
        }
        layoutToTemplatesMap.set(layoutHandle, templatesSet);
    }
    // Iterate over each layout handle
    for (const [handle, templatesSet] of layoutToTemplatesMap) {
        // Iterate over each templateFile
        for (const template of Array.from(templatesSet)) {
            const depsForLayoutHandle = layoutToDepsMap.get(handle);
            // @ts-ignore
            const depsForTemplate = await magentoFS_1.getDepsFromPHTMLPath(template);
            for (const dep of depsForTemplate) {
                depsForLayoutHandle.add(dep);
            }
            layoutToDepsMap.set(handle, depsForLayoutHandle);
        }
    }
    return layoutToDepsMap;
    // read the phtml file,
    // gather the dependencies
    // create the bundle
}
/**
 * @summary Creates and writes the core bundle file for a given theme
 */
async function createCoreBundle(magentoRoot, theme, minifier) {
    const deployedLocales = await magentoFS_1.getLocalesForDeployedTheme(magentoRoot, theme);
    const [firstLocale] = deployedLocales;
    const firstLocaleRoot = path_1.join(magentoRoot, magentoFS_1.getStaticDirForTheme(theme), firstLocale);
    const { requireConfig, rawRequireConfig } = await requireConfig_1.getRequireConfigFromDir(firstLocaleRoot);
    let entryPoints = getEntryPointsFromConfig(requireConfig, theme.themeID);
    const layoutDeps = await getLayoutBasedDeps(magentoRoot, theme);
    // Combine default.xml deps with core bundle
    const defaultDeps = layoutDeps.get('default');
    if (defaultDeps) {
        entryPoints = entryPoints.concat(Array.from(defaultDeps));
        layoutDeps.delete('default');
    }
    const { graph, resolvedEntryIDs } = await traceAMDDependencies_1.traceAMDDependencies(entryPoints, requireConfig, firstLocaleRoot);
    const coreBundleDeps = computeDepsForBundle_1.computeDepsForBundle(graph, resolvedEntryIDs);
    const endBundleTask = cliTask_1.cliTask(`Create core bundle file`, theme.themeID);
    const { bundle, bundleFilename, map } = await createBundleFromDeps_1.createBundleFromDeps('core-bundle', coreBundleDeps, firstLocaleRoot, requireConfig, theme.themeID);
    endBundleTask(`Created core bundle file`);
    // Create bundles for all other layout xml handles
    const otherBundles = new Map();
    const otherBundlesOutput = [];
    for (const [layoutHandle, entryPoints] of layoutDeps) {
        const { graph, resolvedEntryIDs } = await traceAMDDependencies_1.traceAMDDependencies(Array.from(entryPoints), requireConfig, firstLocaleRoot);
        const layoutBundleDeps = computeDepsForBundle_1.computeDepsForBundle(graph, resolvedEntryIDs).filter(dep => !coreBundleDeps.includes(dep));
        // Only create bundles for handles that have dependencies
        if (layoutBundleDeps.length > 0) {
            const endLayoutBundleTask = cliTask_1.cliTask(`Creating bundle for: ${layoutHandle}`, theme.themeID);
            otherBundles.set(layoutHandle, layoutBundleDeps);
            const { bundle, bundleFilename, map } = await createBundleFromDeps_1.createBundleFromDeps(`core-${layoutHandle}`, layoutBundleDeps, firstLocaleRoot, requireConfig, theme.themeID);
            otherBundlesOutput.push([bundle, bundleFilename, map]);
            endLayoutBundleTask(`Creating bundle for: ${layoutHandle}`);
        }
    }
    const newRequireConfig = requireConfig_1.generateBundleRequireConfig(rawRequireConfig, 'core-bundle', coreBundleDeps, otherBundles);
    const endMinifyTask = cliTask_1.cliTask(`Minify core bundle and RequireJS config`, theme.themeID);
    const [minifiedCoreBundle, minifiedRequireConfig, ...otherMinifiedBundles] = await Promise.all([
        minifier.minifyFromString(bundle, bundleFilename, map),
        minifier.minifyFromString(newRequireConfig, 'requirejs-bundle-config.js'),
        // @ts-ignore
        ...otherBundlesOutput.map(otherBundleOutput => minifier.minifyFromString(...otherBundleOutput))
    ]);
    const coreBundleSizes = {
        beforeMin: Buffer.from(bundle).byteLength,
        afterMin: Buffer.from(minifiedCoreBundle.code).byteLength,
    };
    const requireConfigSizes = {
        beforeMin: Buffer.from(rawRequireConfig).byteLength,
        afterMin: Buffer.from(minifiedRequireConfig.code).byteLength,
    };
    endMinifyTask(`Minified core bundle and RequireJS`);
    const files = [
        {
            pathFromLocaleRoot: path_1.join(BALER_META_DIR, bundleFilename),
            source: minifiedCoreBundle.code,
        },
        {
            pathFromLocaleRoot: path_1.join(BALER_META_DIR, `${bundleFilename}.map`),
            source: minifiedCoreBundle.map,
        },
        {
            pathFromLocaleRoot: 'requirejs-bundle-config.js',
            source: minifiedRequireConfig.code,
        },
        {
            pathFromLocaleRoot: 'requirejs-bundle-config.js.map',
            source: minifiedRequireConfig.map,
        },
    ];
    let idx = 0;
    for (const [, otherBundleFileName] of otherBundlesOutput) {
        const minifiedBundle = otherMinifiedBundles[idx];
        files.push({
            pathFromLocaleRoot: path_1.join(BALER_META_DIR, otherBundleFileName),
            // @ts-ignore
            source: minifiedBundle.code
        });
        files.push({
            pathFromLocaleRoot: path_1.join(BALER_META_DIR, `${otherBundleFileName}.map`),
            // @ts-ignore
            source: minifiedBundle.map
        });
        idx++;
    }
    await writeFilesToAllLocales(magentoRoot, theme, files, deployedLocales);
    return {
        baseLocale: firstLocale,
        entryPoints: resolvedEntryIDs,
        graph,
        coreBundleSizes,
        requireConfigSizes,
    };
}
async function writeFilesToAllLocales(magentoRoot, theme, files, locales) {
    const staticDir = magentoFS_1.getStaticDirForTheme(theme);
    const pendingWrites = flatten_1.flatten(files.map(file => {
        return locales.map(async (locale) => {
            const path = path_1.join(magentoRoot, staticDir, locale, file.pathFromLocaleRoot);
            await writeFileWithMkDir(path, file.source);
        });
    }));
    await Promise.all(pendingWrites);
}
async function writeFileWithMkDir(path, source) {
    const dir = path_1.dirname(path);
    await fsPromises_1.mkdir(dir, { recursive: true });
    await fsPromises_1.writeFile(path, source);
}
function getThemeByID(themeID, themes) {
    const theme = themes[themeID];
    if (!theme) {
        throw new BalerError_1.BalerError(`Attempted to optimize "${themeID}", but it was ` +
            'not found in the store.');
    }
    return theme;
}
function throwOnDisallowedTheme(theme) {
    if (theme.area !== 'frontend') {
        throw new BalerError_1.BalerError(`Cannot optimize theme "${theme.themeID}" ` +
            'because only "frontend" themes are supported by baler');
    }
    if (theme.themeID === 'Magento/blank') {
        // Only reason we're doing this check is because it's likely
        // a mistake 99.9% of the time if you try to bundle blank
        throw new BalerError_1.BalerError(`Optimization of "Magento/blank" is not supported`);
    }
}
function getEntryPointsFromConfig(requireConfig, themeID) {
    const entries = requireConfig.deps;
    if (Array.isArray(entries) && entries.length) {
        return entries;
    }
    throw new BalerError_1.BalerError(`Could not find any entry points ("deps") config in ` +
        `"requirejs-config.js" for theme "${themeID}"`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3B0aW1pemVUaGVtZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvb3B0aW1pemVUaGVtZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7QUFHSCwrQkFBcUM7QUFDckMscURBQTREO0FBQzVELDJDQVNxQjtBQUNyQixtREFHeUI7QUFDekIsaUVBQThEO0FBQzlELGlFQUE4RDtBQUM5RCxpRUFBOEQ7QUFDOUQsNkNBQWdEO0FBQ2hELHVDQUFvQztBQUNwQyx1Q0FBb0M7QUFDcEMsNkNBQTBDO0FBRTFDLE1BQU0sY0FBYyxHQUFHLGNBQWMsQ0FBQztBQUV0Qzs7R0FFRztBQUNJLEtBQUssVUFBVSxjQUFjLENBQ2hDLFdBQW1CLEVBQ25CLEtBQWdCLEVBQ2hCLGdCQUEwQjtJQUUxQix1RUFBdUU7SUFDdkUsTUFBTSxRQUFRLEdBQUcsK0JBQWMsRUFBRSxDQUFDO0lBRWxDLE1BQU0sbUJBQW1CLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBQyxPQUFPLEVBQUMsRUFBRTtRQUM3RCxNQUFNLEtBQUssR0FBRyxZQUFZLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDN0Qsc0JBQXNCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFOUIsSUFBSTtZQUNBLE1BQU0sTUFBTSxHQUFHLE1BQU0sYUFBYSxDQUM5QixXQUFXLEVBQ1gsS0FBSyxFQUNMLEtBQUssRUFDTCxRQUFRLENBQ1gsQ0FBQztZQUNGLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsQ0FBQztTQUM3QztRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ1osT0FBTyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDO1NBQzdDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLFlBQVksR0FBRyxNQUFNLE9BQU8sQ0FB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QXdCLENBQzdCLGFBQW1DLEVBQ25DLE9BQWU7SUFFZixNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDO0lBQ25DLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFO1FBQzFDLE9BQU8sT0FBTyxDQUFDO0tBQ2xCO0lBRUQsTUFBTSxJQUFJLHVCQUFVLENBQ2hCLHFEQUFxRDtRQUNqRCxvQ0FBb0MsT0FBTyxHQUFHLENBQ3JELENBQUM7QUFDTixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgwqkgTWFnZW50bywgSW5jLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogU2VlIENPUFlJTkcudHh0IGZvciBsaWNlbnNlIGRldGFpbHMuXG4gKi9cblxuaW1wb3J0IHsgU3RvcmVEYXRhLCBUaGVtZSwgTWFnZW50b1JlcXVpcmVDb25maWcgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IGpvaW4sIGRpcm5hbWUgfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IGNyZWF0ZU1pbmlmaWVyLCBNaW5pZmllciB9IGZyb20gJy4vY3JlYXRlTWluaWZpZXInO1xuaW1wb3J0IHtcbiAgICBnZXRMb2NhbGVzRm9yRGVwbG95ZWRUaGVtZSxcbiAgICBnZXRTdGF0aWNEaXJGb3JUaGVtZSxcbiAgICBnZXRQSFRNTEZpbGVzRWxpZ2libGVGb3JVc2VXaXRoVGhlbWUsXG4gICAgZ2V0TGF5b3V0RmlsZXNFbGlnaWJsZUZvclVzZVdpdGhUaGVtZSxcbiAgICBnZXRFbmFibGVkTW9kdWxlcyxcbiAgICBnZXRDb21wb25lbnRzLFxuICAgIGdldFBIVE1MRmlsZXNGcm9tTGF5b3V0SGFuZGxlLFxuICAgIGdldERlcHNGcm9tUEhUTUxQYXRoXG59IGZyb20gJy4vbWFnZW50b0ZTJztcbmltcG9ydCB7XG4gICAgZ2V0UmVxdWlyZUNvbmZpZ0Zyb21EaXIsXG4gICAgZ2VuZXJhdGVCdW5kbGVSZXF1aXJlQ29uZmlnLFxufSBmcm9tICcuL3JlcXVpcmVDb25maWcnO1xuaW1wb3J0IHsgdHJhY2VBTUREZXBlbmRlbmNpZXMgfSBmcm9tICcuL3RyYWNlQU1ERGVwZW5kZW5jaWVzJztcbmltcG9ydCB7IGNvbXB1dGVEZXBzRm9yQnVuZGxlIH0gZnJvbSAnLi9jb21wdXRlRGVwc0ZvckJ1bmRsZSc7XG5pbXBvcnQgeyBjcmVhdGVCdW5kbGVGcm9tRGVwcyB9IGZyb20gJy4vY3JlYXRlQnVuZGxlRnJvbURlcHMnO1xuaW1wb3J0IHsgd3JpdGVGaWxlLCBta2RpciB9IGZyb20gJy4vZnNQcm9taXNlcyc7XG5pbXBvcnQgeyBmbGF0dGVuIH0gZnJvbSAnLi9mbGF0dGVuJztcbmltcG9ydCB7IGNsaVRhc2sgfSBmcm9tICcuL2NsaVRhc2snO1xuaW1wb3J0IHsgQmFsZXJFcnJvciB9IGZyb20gJy4vQmFsZXJFcnJvcic7XG5cbmNvbnN0IEJBTEVSX01FVEFfRElSID0gJ2JhbGVyYnVuZGxlcyc7XG5cbi8qKlxuICogQHN1bW1hcnkgT3B0aW1pemUgYWxsIGVsaWdpYmxlIHRoZW1lcyBpbiBhIE1hZ2VudG8gMiBzdG9yZVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gb3B0aW1pemVUaGVtZXMoXG4gICAgbWFnZW50b1Jvb3Q6IHN0cmluZyxcbiAgICBzdG9yZTogU3RvcmVEYXRhLFxuICAgIHRoZW1lc1RvT3B0aW1pemU6IHN0cmluZ1tdLFxuKSB7XG4gICAgLy8gU3BpbnMgdXAgYSB3b3JrZXIgcG9vbCwgc28gd2Ugb25seSB3YW50IHRvIGRvIGl0IG9uY2UsIG5vdCBwZXItdGhlbWVcbiAgICBjb25zdCBtaW5pZmllciA9IGNyZWF0ZU1pbmlmaWVyKCk7XG5cbiAgICBjb25zdCBwZW5kaW5nVGhlbWVSZXN1bHRzID0gdGhlbWVzVG9PcHRpbWl6ZS5tYXAoYXN5bmMgdGhlbWVJRCA9PiB7XG4gICAgICAgIGNvbnN0IHRoZW1lID0gZ2V0VGhlbWVCeUlEKHRoZW1lSUQsIHN0b3JlLmNvbXBvbmVudHMudGhlbWVzKTtcbiAgICAgICAgdGhyb3dPbkRpc2FsbG93ZWRUaGVtZSh0aGVtZSk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG9wdGltaXplVGhlbWUoXG4gICAgICAgICAgICAgICAgbWFnZW50b1Jvb3QsXG4gICAgICAgICAgICAgICAgc3RvcmUsXG4gICAgICAgICAgICAgICAgdGhlbWUsXG4gICAgICAgICAgICAgICAgbWluaWZpZXIsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmV0dXJuIHsgdGhlbWVJRCwgc3VjY2VzczogdHJ1ZSwgcmVzdWx0IH07XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4geyB0aGVtZUlELCBzdWNjZXNzOiBmYWxzZSwgZXJyb3IgfTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgdGhlbWVSZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwocGVuZGluZ1RoZW1lUmVzdWx0cyk7XG4gICAgbWluaWZpZXIuZGVzdHJveSgpO1xuXG4gICAgcmV0dXJuIHRoZW1lUmVzdWx0cztcbn1cblxuLyoqXG4gKiBAc3VtbWFyeSBPcHRpbWl6ZSBhIHNpbmdsZSB0aGVtZSBpbiBhIE1hZ2VudG8gMiBzdG9yZVxuICovXG5hc3luYyBmdW5jdGlvbiBvcHRpbWl6ZVRoZW1lKFxuICAgIG1hZ2VudG9Sb290OiBzdHJpbmcsXG4gICAgc3RvcmU6IFN0b3JlRGF0YSxcbiAgICB0aGVtZTogVGhlbWUsXG4gICAgbWluaWZpZXI6IE1pbmlmaWVyLFxuKSB7XG4gICAgY29uc3QgY29yZUJ1bmRsZVJlc3VsdHMgPSBhd2FpdCBjcmVhdGVDb3JlQnVuZGxlKFxuICAgICAgICBtYWdlbnRvUm9vdCxcbiAgICAgICAgdGhlbWUsXG4gICAgICAgIG1pbmlmaWVyLFxuICAgICk7XG5cbiAgICByZXR1cm4gY29yZUJ1bmRsZVJlc3VsdHM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldExheW91dEJhc2VkRGVwcyhcbiAgICBtYWdlbnRvUm9vdDogc3RyaW5nLFxuICAgIHRoZW1lOiBUaGVtZVxuKTogUHJvbWlzZTxNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4+IHtcbiAgICBjb25zdCBlbmFibGVkTW9kdWxlcyA9IGF3YWl0IGdldEVuYWJsZWRNb2R1bGVzKG1hZ2VudG9Sb290KTtcbiAgICBjb25zdCB7IG1vZHVsZXMsIHRoZW1lcyB9ID0gYXdhaXQgZ2V0Q29tcG9uZW50cyhtYWdlbnRvUm9vdCk7XG4gICAgY29uc3QgdGhlbWVGYWxsYmFjayA9IFtdO1xuICAgIGxldCBwcm9jZXNzaW5nID0gdHJ1ZTtcbiAgICBsZXQgY3VycmVudEZhbGxiYWNrID0gdGhlbWU7XG5cbiAgICAvLyBDcmVhdGUgdGhlbWUgZmFsbGJhY2tcbiAgICB3aGlsZSAocHJvY2Vzc2luZykge1xuICAgICAgICB0aGVtZUZhbGxiYWNrLnB1c2goY3VycmVudEZhbGxiYWNrKTtcbiAgICAgICAgaWYgKGN1cnJlbnRGYWxsYmFjay5wYXJlbnRJRCkge1xuICAgICAgICAgICAgY3VycmVudEZhbGxiYWNrID0gdGhlbWVzW2N1cnJlbnRGYWxsYmFjay5wYXJlbnRJRF1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHByb2Nlc3NpbmcgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIEdldCBhbGwgbGF5b3V0IGZpbGVzXG4gICAgY29uc3QgbGF5b3V0RmlsZXMgPSBhd2FpdCBnZXRMYXlvdXRGaWxlc0VsaWdpYmxlRm9yVXNlV2l0aFRoZW1lKFxuICAgICAgICB0aGVtZUZhbGxiYWNrLFxuICAgICAgICBlbmFibGVkTW9kdWxlcyxcbiAgICAgICAgbW9kdWxlc1xuICAgICk7XG4gICAgY29uc29sZS5sb2cocHJvY2Vzcy5jd2QoKSk7XG5cbiAgICAvLyBMb2dnaW5nIHRvIGZpZ3VyZSBvdXQgaWYgYSBnbG9iIGlzIGZhaWxpbmcgb24gY2xvdWRcbiAgICBjb25zb2xlLmxvZyhsYXlvdXRGaWxlcyk7XG5cbiAgICAvLyBDcmVhdGUgYSBtYXAgb2YgbGF5b3V0IGZpbGUgPT4gdGVtcGxhdGVGaWxlc1tdXG4gICAgY29uc3QgbGF5b3V0VG9UZW1wbGF0ZXNNYXAgPSBuZXcgTWFwKCk7XG4gICAgLy8gQ3JlYXRlIGEgbWFwIG9mIGxheW91dCBmaWxlID0+IGpzW11cbiAgICBjb25zdCBsYXlvdXRUb0RlcHNNYXAgPSBuZXcgTWFwKCk7XG5cbiAgICBmb3IgKGNvbnN0IGxheW91dEZpbGUgb2YgbGF5b3V0RmlsZXMpIHtcbiAgICAgICAgbGV0IGxheW91dEhhbmRsZSA9IGxheW91dEZpbGUuc3BsaXQoJy8nKS5wb3AoKTtcbiAgICAgICAgaWYgKCFsYXlvdXRIYW5kbGUpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGF5b3V0SGFuZGxlID0gbGF5b3V0SGFuZGxlLnJlcGxhY2UoJy54bWwnLCAnJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFsYXlvdXRUb1RlbXBsYXRlc01hcC5oYXMobGF5b3V0SGFuZGxlKSkge1xuICAgICAgICAgICAgbGF5b3V0VG9UZW1wbGF0ZXNNYXAuc2V0KGxheW91dEhhbmRsZSwgbmV3IFNldCgpKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIWxheW91dFRvRGVwc01hcC5oYXMobGF5b3V0SGFuZGxlKSkge1xuICAgICAgICAgICAgbGF5b3V0VG9EZXBzTWFwLnNldChsYXlvdXRIYW5kbGUsIG5ldyBTZXQoKSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdGVtcGxhdGVzU2V0ID0gbGF5b3V0VG9UZW1wbGF0ZXNNYXAuZ2V0KGxheW91dEhhbmRsZSk7XG4gICAgICAgIGNvbnN0IHRlbXBsYXRlcyA9IGF3YWl0IGdldFBIVE1MRmlsZXNGcm9tTGF5b3V0SGFuZGxlKGxheW91dEZpbGUsIHRoZW1lRmFsbGJhY2ssIG1vZHVsZXMpO1xuICAgICAgICBmb3IgKGNvbnN0IHRlbXBsYXRlIG9mIHRlbXBsYXRlcykge1xuICAgICAgICAgICAgdGVtcGxhdGVzU2V0LmFkZCh0ZW1wbGF0ZSk7XG4gICAgICAgIH1cbiAgICAgICAgbGF5b3V0VG9UZW1wbGF0ZXNNYXAuc2V0KGxheW91dEhhbmRsZSwgdGVtcGxhdGVzU2V0KTtcbiAgICB9XG5cblxuICAgIC8vIEl0ZXJhdGUgb3ZlciBlYWNoIGxheW91dCBoYW5kbGVcbiAgICBmb3IgKGNvbnN0IFtoYW5kbGUsIHRlbXBsYXRlc1NldF0gb2YgbGF5b3V0VG9UZW1wbGF0ZXNNYXApIHtcbiAgICAgICAgLy8gSXRlcmF0ZSBvdmVyIGVhY2ggdGVtcGxhdGVGaWxlXG4gICAgICAgIGZvciAoY29uc3QgdGVtcGxhdGUgb2YgQXJyYXkuZnJvbSh0ZW1wbGF0ZXNTZXQpKSB7XG4gICAgICAgICAgICBjb25zdCBkZXBzRm9yTGF5b3V0SGFuZGxlID0gbGF5b3V0VG9EZXBzTWFwLmdldChoYW5kbGUpO1xuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgY29uc3QgZGVwc0ZvclRlbXBsYXRlID0gYXdhaXQgZ2V0RGVwc0Zyb21QSFRNTFBhdGgodGVtcGxhdGUpO1xuICAgICAgICAgICAgZm9yIChjb25zdCBkZXAgb2YgZGVwc0ZvclRlbXBsYXRlKSB7XG4gICAgICAgICAgICAgICAgZGVwc0ZvckxheW91dEhhbmRsZS5hZGQoZGVwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxheW91dFRvRGVwc01hcC5zZXQoaGFuZGxlLCBkZXBzRm9yTGF5b3V0SGFuZGxlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBsYXlvdXRUb0RlcHNNYXA7XG4gICAgLy8gcmVhZCB0aGUgcGh0bWwgZmlsZSxcbiAgICAvLyBnYXRoZXIgdGhlIGRlcGVuZGVuY2llc1xuICAgIC8vIGNyZWF0ZSB0aGUgYnVuZGxlXG59XG5cbi8qKlxuICogQHN1bW1hcnkgQ3JlYXRlcyBhbmQgd3JpdGVzIHRoZSBjb3JlIGJ1bmRsZSBmaWxlIGZvciBhIGdpdmVuIHRoZW1lXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUNvcmVCdW5kbGUoXG4gICAgbWFnZW50b1Jvb3Q6IHN0cmluZyxcbiAgICB0aGVtZTogVGhlbWUsXG4gICAgbWluaWZpZXI6IE1pbmlmaWVyLFxuKSB7XG4gICAgY29uc3QgZGVwbG95ZWRMb2NhbGVzID0gYXdhaXQgZ2V0TG9jYWxlc0ZvckRlcGxveWVkVGhlbWUoXG4gICAgICAgIG1hZ2VudG9Sb290LFxuICAgICAgICB0aGVtZSxcbiAgICApO1xuXG4gICAgY29uc3QgW2ZpcnN0TG9jYWxlXSA9IGRlcGxveWVkTG9jYWxlcztcbiAgICBjb25zdCBmaXJzdExvY2FsZVJvb3QgPSBqb2luKFxuICAgICAgICBtYWdlbnRvUm9vdCxcbiAgICAgICAgZ2V0U3RhdGljRGlyRm9yVGhlbWUodGhlbWUpLFxuICAgICAgICBmaXJzdExvY2FsZSxcbiAgICApO1xuXG4gICAgY29uc3QgeyByZXF1aXJlQ29uZmlnLCByYXdSZXF1aXJlQ29uZmlnIH0gPSBhd2FpdCBnZXRSZXF1aXJlQ29uZmlnRnJvbURpcihcbiAgICAgICAgZmlyc3RMb2NhbGVSb290LFxuICAgICk7XG4gICAgbGV0IGVudHJ5UG9pbnRzID0gZ2V0RW50cnlQb2ludHNGcm9tQ29uZmlnKHJlcXVpcmVDb25maWcsIHRoZW1lLnRoZW1lSUQpO1xuICAgIGNvbnN0IGxheW91dERlcHMgPSBhd2FpdCBnZXRMYXlvdXRCYXNlZERlcHMoXG4gICAgICAgIG1hZ2VudG9Sb290LFxuICAgICAgICB0aGVtZVxuICAgICk7XG4gICAgLy8gQ29tYmluZSBkZWZhdWx0LnhtbCBkZXBzIHdpdGggY29yZSBidW5kbGVcbiAgICBjb25zdCBkZWZhdWx0RGVwcyA9IGxheW91dERlcHMuZ2V0KCdkZWZhdWx0Jyk7XG4gICAgaWYgKGRlZmF1bHREZXBzKSB7XG4gICAgICAgIGVudHJ5UG9pbnRzID0gZW50cnlQb2ludHMuY29uY2F0KEFycmF5LmZyb20oZGVmYXVsdERlcHMpKVxuICAgICAgICBsYXlvdXREZXBzLmRlbGV0ZSgnZGVmYXVsdCcpO1xuICAgIH1cblxuICAgIGNvbnN0IHsgZ3JhcGgsIHJlc29sdmVkRW50cnlJRHMgfSA9IGF3YWl0IHRyYWNlQU1ERGVwZW5kZW5jaWVzKFxuICAgICAgICBlbnRyeVBvaW50cyxcbiAgICAgICAgcmVxdWlyZUNvbmZpZyxcbiAgICAgICAgZmlyc3RMb2NhbGVSb290LFxuICAgICk7XG4gICAgY29uc3QgY29yZUJ1bmRsZURlcHMgPSBjb21wdXRlRGVwc0ZvckJ1bmRsZShncmFwaCwgcmVzb2x2ZWRFbnRyeUlEcyk7XG5cbiAgICBjb25zdCBlbmRCdW5kbGVUYXNrID0gY2xpVGFzayhgQ3JlYXRlIGNvcmUgYnVuZGxlIGZpbGVgLCB0aGVtZS50aGVtZUlEKTtcbiAgICBjb25zdCB7IGJ1bmRsZSwgYnVuZGxlRmlsZW5hbWUsIG1hcCB9ID0gYXdhaXQgY3JlYXRlQnVuZGxlRnJvbURlcHMoXG4gICAgICAgICdjb3JlLWJ1bmRsZScsXG4gICAgICAgIGNvcmVCdW5kbGVEZXBzLFxuICAgICAgICBmaXJzdExvY2FsZVJvb3QsXG4gICAgICAgIHJlcXVpcmVDb25maWcsXG4gICAgICAgIHRoZW1lLnRoZW1lSUQsXG4gICAgKTtcbiAgICBlbmRCdW5kbGVUYXNrKGBDcmVhdGVkIGNvcmUgYnVuZGxlIGZpbGVgKTtcblxuICAgIC8vIENyZWF0ZSBidW5kbGVzIGZvciBhbGwgb3RoZXIgbGF5b3V0IHhtbCBoYW5kbGVzXG4gICAgY29uc3Qgb3RoZXJCdW5kbGVzID0gbmV3IE1hcCgpO1xuICAgIGNvbnN0IG90aGVyQnVuZGxlc091dHB1dCA9IFtdO1xuICAgIGZvciAoY29uc3QgWyBsYXlvdXRIYW5kbGUsIGVudHJ5UG9pbnRzIF0gb2YgbGF5b3V0RGVwcykge1xuICAgICAgICBjb25zdCB7IGdyYXBoLCByZXNvbHZlZEVudHJ5SURzIH0gPSBhd2FpdCB0cmFjZUFNRERlcGVuZGVuY2llcyhcbiAgICAgICAgICAgIEFycmF5LmZyb20oZW50cnlQb2ludHMpLFxuICAgICAgICAgICAgcmVxdWlyZUNvbmZpZyxcbiAgICAgICAgICAgIGZpcnN0TG9jYWxlUm9vdCxcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3QgbGF5b3V0QnVuZGxlRGVwcyA9IGNvbXB1dGVEZXBzRm9yQnVuZGxlKGdyYXBoLCByZXNvbHZlZEVudHJ5SURzKS5maWx0ZXIoZGVwID0+ICFjb3JlQnVuZGxlRGVwcy5pbmNsdWRlcyhkZXApKTtcbiAgICAgICAgLy8gT25seSBjcmVhdGUgYnVuZGxlcyBmb3IgaGFuZGxlcyB0aGF0IGhhdmUgZGVwZW5kZW5jaWVzXG4gICAgICAgIGlmIChsYXlvdXRCdW5kbGVEZXBzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IGVuZExheW91dEJ1bmRsZVRhc2sgPSBjbGlUYXNrKGBDcmVhdGluZyBidW5kbGUgZm9yOiAke2xheW91dEhhbmRsZX1gLCB0aGVtZS50aGVtZUlEKTtcbiAgICAgICAgICAgIG90aGVyQnVuZGxlcy5zZXQobGF5b3V0SGFuZGxlLCBsYXlvdXRCdW5kbGVEZXBzKTtcbiAgICAgICAgICAgIGNvbnN0IHsgYnVuZGxlLCBidW5kbGVGaWxlbmFtZSwgbWFwIH0gPSBhd2FpdCBjcmVhdGVCdW5kbGVGcm9tRGVwcyhcbiAgICAgICAgICAgICAgICBgY29yZS0ke2xheW91dEhhbmRsZX1gLFxuICAgICAgICAgICAgICAgIGxheW91dEJ1bmRsZURlcHMsXG4gICAgICAgICAgICAgICAgZmlyc3RMb2NhbGVSb290LFxuICAgICAgICAgICAgICAgIHJlcXVpcmVDb25maWcsXG4gICAgICAgICAgICAgICAgdGhlbWUudGhlbWVJRFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIG90aGVyQnVuZGxlc091dHB1dC5wdXNoKFtidW5kbGUsIGJ1bmRsZUZpbGVuYW1lLCBtYXBdKVxuICAgICAgICAgICAgZW5kTGF5b3V0QnVuZGxlVGFzayhgQ3JlYXRpbmcgYnVuZGxlIGZvcjogJHtsYXlvdXRIYW5kbGV9YCk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIGNvbnN0IG5ld1JlcXVpcmVDb25maWcgPSBnZW5lcmF0ZUJ1bmRsZVJlcXVpcmVDb25maWcoXG4gICAgICAgIHJhd1JlcXVpcmVDb25maWcsXG4gICAgICAgICdjb3JlLWJ1bmRsZScsXG4gICAgICAgIGNvcmVCdW5kbGVEZXBzLFxuICAgICAgICBvdGhlckJ1bmRsZXNcbiAgICApO1xuXG4gICAgY29uc3QgZW5kTWluaWZ5VGFzayA9IGNsaVRhc2soXG4gICAgICAgIGBNaW5pZnkgY29yZSBidW5kbGUgYW5kIFJlcXVpcmVKUyBjb25maWdgLFxuICAgICAgICB0aGVtZS50aGVtZUlELFxuICAgICk7XG4gICAgY29uc3QgW21pbmlmaWVkQ29yZUJ1bmRsZSwgbWluaWZpZWRSZXF1aXJlQ29uZmlnLCAuLi5vdGhlck1pbmlmaWVkQnVuZGxlc10gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIG1pbmlmaWVyLm1pbmlmeUZyb21TdHJpbmcoYnVuZGxlLCBidW5kbGVGaWxlbmFtZSwgbWFwKSxcbiAgICAgICAgbWluaWZpZXIubWluaWZ5RnJvbVN0cmluZyhcbiAgICAgICAgICAgIG5ld1JlcXVpcmVDb25maWcsXG4gICAgICAgICAgICAncmVxdWlyZWpzLWJ1bmRsZS1jb25maWcuanMnLFxuICAgICAgICApLFxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIC4uLm90aGVyQnVuZGxlc091dHB1dC5tYXAob3RoZXJCdW5kbGVPdXRwdXQgPT4gbWluaWZpZXIubWluaWZ5RnJvbVN0cmluZyguLi5vdGhlckJ1bmRsZU91dHB1dCkpXG4gICAgXSk7XG4gICAgY29uc3QgY29yZUJ1bmRsZVNpemVzID0ge1xuICAgICAgICBiZWZvcmVNaW46IEJ1ZmZlci5mcm9tKGJ1bmRsZSkuYnl0ZUxlbmd0aCxcbiAgICAgICAgYWZ0ZXJNaW46IEJ1ZmZlci5mcm9tKG1pbmlmaWVkQ29yZUJ1bmRsZS5jb2RlKS5ieXRlTGVuZ3RoLFxuICAgIH07XG4gICAgY29uc3QgcmVxdWlyZUNvbmZpZ1NpemVzID0ge1xuICAgICAgICBiZWZvcmVNaW46IEJ1ZmZlci5mcm9tKHJhd1JlcXVpcmVDb25maWcpLmJ5dGVMZW5ndGgsXG4gICAgICAgIGFmdGVyTWluOiBCdWZmZXIuZnJvbShtaW5pZmllZFJlcXVpcmVDb25maWcuY29kZSkuYnl0ZUxlbmd0aCxcbiAgICB9O1xuICAgIGVuZE1pbmlmeVRhc2soYE1pbmlmaWVkIGNvcmUgYnVuZGxlIGFuZCBSZXF1aXJlSlNgKTtcblxuICAgIGNvbnN0IGZpbGVzID0gW1xuICAgICAgICB7XG4gICAgICAgICAgICBwYXRoRnJvbUxvY2FsZVJvb3Q6IGpvaW4oQkFMRVJfTUVUQV9ESVIsIGJ1bmRsZUZpbGVuYW1lKSxcbiAgICAgICAgICAgIHNvdXJjZTogbWluaWZpZWRDb3JlQnVuZGxlLmNvZGUsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIHBhdGhGcm9tTG9jYWxlUm9vdDogam9pbihCQUxFUl9NRVRBX0RJUiwgYCR7YnVuZGxlRmlsZW5hbWV9Lm1hcGApLFxuICAgICAgICAgICAgc291cmNlOiBtaW5pZmllZENvcmVCdW5kbGUubWFwLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBwYXRoRnJvbUxvY2FsZVJvb3Q6ICdyZXF1aXJlanMtYnVuZGxlLWNvbmZpZy5qcycsXG4gICAgICAgICAgICBzb3VyY2U6IG1pbmlmaWVkUmVxdWlyZUNvbmZpZy5jb2RlLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBwYXRoRnJvbUxvY2FsZVJvb3Q6ICdyZXF1aXJlanMtYnVuZGxlLWNvbmZpZy5qcy5tYXAnLFxuICAgICAgICAgICAgc291cmNlOiBtaW5pZmllZFJlcXVpcmVDb25maWcubWFwLFxuICAgICAgICB9LFxuICAgIF07XG4gICAgbGV0IGlkeCA9IDA7XG4gICAgZm9yIChjb25zdCBbLCBvdGhlckJ1bmRsZUZpbGVOYW1lXSBvZiBvdGhlckJ1bmRsZXNPdXRwdXQpIHtcbiAgICAgICAgY29uc3QgbWluaWZpZWRCdW5kbGUgPSBvdGhlck1pbmlmaWVkQnVuZGxlc1tpZHhdO1xuICAgICAgICBmaWxlcy5wdXNoKHtcbiAgICAgICAgICAgIHBhdGhGcm9tTG9jYWxlUm9vdDogam9pbihCQUxFUl9NRVRBX0RJUiwgb3RoZXJCdW5kbGVGaWxlTmFtZSksXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICBzb3VyY2U6IG1pbmlmaWVkQnVuZGxlLmNvZGVcbiAgICAgICAgfSk7XG4gICAgICAgIGZpbGVzLnB1c2goe1xuICAgICAgICAgICAgcGF0aEZyb21Mb2NhbGVSb290OiBqb2luKEJBTEVSX01FVEFfRElSLCBgJHtvdGhlckJ1bmRsZUZpbGVOYW1lfS5tYXBgKSxcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIHNvdXJjZTogbWluaWZpZWRCdW5kbGUubWFwXG4gICAgICAgIH0pO1xuICAgICAgICBpZHgrKztcbiAgICB9XG5cbiAgICBhd2FpdCB3cml0ZUZpbGVzVG9BbGxMb2NhbGVzKG1hZ2VudG9Sb290LCB0aGVtZSwgZmlsZXMsIGRlcGxveWVkTG9jYWxlcyk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBiYXNlTG9jYWxlOiBmaXJzdExvY2FsZSxcbiAgICAgICAgZW50cnlQb2ludHM6IHJlc29sdmVkRW50cnlJRHMsXG4gICAgICAgIGdyYXBoLFxuICAgICAgICBjb3JlQnVuZGxlU2l6ZXMsXG4gICAgICAgIHJlcXVpcmVDb25maWdTaXplcyxcbiAgICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiB3cml0ZUZpbGVzVG9BbGxMb2NhbGVzKFxuICAgIG1hZ2VudG9Sb290OiBzdHJpbmcsXG4gICAgdGhlbWU6IFRoZW1lLFxuICAgIGZpbGVzOiB7IHBhdGhGcm9tTG9jYWxlUm9vdDogc3RyaW5nOyBzb3VyY2U6IHN0cmluZyB9W10sXG4gICAgbG9jYWxlczogc3RyaW5nW10sXG4pIHtcbiAgICBjb25zdCBzdGF0aWNEaXIgPSBnZXRTdGF0aWNEaXJGb3JUaGVtZSh0aGVtZSk7XG5cbiAgICBjb25zdCBwZW5kaW5nV3JpdGVzID0gZmxhdHRlbihcbiAgICAgICAgZmlsZXMubWFwKGZpbGUgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGxvY2FsZXMubWFwKGFzeW5jIGxvY2FsZSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGF0aCA9IGpvaW4oXG4gICAgICAgICAgICAgICAgICAgIG1hZ2VudG9Sb290LFxuICAgICAgICAgICAgICAgICAgICBzdGF0aWNEaXIsXG4gICAgICAgICAgICAgICAgICAgIGxvY2FsZSxcbiAgICAgICAgICAgICAgICAgICAgZmlsZS5wYXRoRnJvbUxvY2FsZVJvb3QsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBhd2FpdCB3cml0ZUZpbGVXaXRoTWtEaXIocGF0aCwgZmlsZS5zb3VyY2UpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pLFxuICAgICk7XG5cbiAgICBhd2FpdCBQcm9taXNlLmFsbChwZW5kaW5nV3JpdGVzKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gd3JpdGVGaWxlV2l0aE1rRGlyKHBhdGg6IHN0cmluZywgc291cmNlOiBzdHJpbmcpIHtcbiAgICBjb25zdCBkaXIgPSBkaXJuYW1lKHBhdGgpO1xuICAgIGF3YWl0IG1rZGlyKGRpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgYXdhaXQgd3JpdGVGaWxlKHBhdGgsIHNvdXJjZSk7XG59XG5cbmZ1bmN0aW9uIGdldFRoZW1lQnlJRCh0aGVtZUlEOiBzdHJpbmcsIHRoZW1lczogUmVjb3JkPHN0cmluZywgVGhlbWU+KSB7XG4gICAgY29uc3QgdGhlbWUgPSB0aGVtZXNbdGhlbWVJRF07XG4gICAgaWYgKCF0aGVtZSkge1xuICAgICAgICB0aHJvdyBuZXcgQmFsZXJFcnJvcihcbiAgICAgICAgICAgIGBBdHRlbXB0ZWQgdG8gb3B0aW1pemUgXCIke3RoZW1lSUR9XCIsIGJ1dCBpdCB3YXMgYCArXG4gICAgICAgICAgICAgICAgJ25vdCBmb3VuZCBpbiB0aGUgc3RvcmUuJyxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhlbWU7XG59XG5cbmZ1bmN0aW9uIHRocm93T25EaXNhbGxvd2VkVGhlbWUodGhlbWU6IFRoZW1lKSB7XG4gICAgaWYgKHRoZW1lLmFyZWEgIT09ICdmcm9udGVuZCcpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhbGVyRXJyb3IoXG4gICAgICAgICAgICBgQ2Fubm90IG9wdGltaXplIHRoZW1lIFwiJHt0aGVtZS50aGVtZUlEfVwiIGAgK1xuICAgICAgICAgICAgICAgICdiZWNhdXNlIG9ubHkgXCJmcm9udGVuZFwiIHRoZW1lcyBhcmUgc3VwcG9ydGVkIGJ5IGJhbGVyJyxcbiAgICAgICAgKTtcbiAgICB9XG4gICAgaWYgKHRoZW1lLnRoZW1lSUQgPT09ICdNYWdlbnRvL2JsYW5rJykge1xuICAgICAgICAvLyBPbmx5IHJlYXNvbiB3ZSdyZSBkb2luZyB0aGlzIGNoZWNrIGlzIGJlY2F1c2UgaXQncyBsaWtlbHlcbiAgICAgICAgLy8gYSBtaXN0YWtlIDk5LjklIG9mIHRoZSB0aW1lIGlmIHlvdSB0cnkgdG8gYnVuZGxlIGJsYW5rXG4gICAgICAgIHRocm93IG5ldyBCYWxlckVycm9yKFxuICAgICAgICAgICAgYE9wdGltaXphdGlvbiBvZiBcIk1hZ2VudG8vYmxhbmtcIiBpcyBub3Qgc3VwcG9ydGVkYCxcbiAgICAgICAgKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGdldEVudHJ5UG9pbnRzRnJvbUNvbmZpZyhcbiAgICByZXF1aXJlQ29uZmlnOiBNYWdlbnRvUmVxdWlyZUNvbmZpZyxcbiAgICB0aGVtZUlEOiBzdHJpbmcsXG4pIHtcbiAgICBjb25zdCBlbnRyaWVzID0gcmVxdWlyZUNvbmZpZy5kZXBzO1xuICAgIGlmIChBcnJheS5pc0FycmF5KGVudHJpZXMpICYmIGVudHJpZXMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBlbnRyaWVzO1xuICAgIH1cblxuICAgIHRocm93IG5ldyBCYWxlckVycm9yKFxuICAgICAgICBgQ291bGQgbm90IGZpbmQgYW55IGVudHJ5IHBvaW50cyAoXCJkZXBzXCIpIGNvbmZpZyBpbiBgICtcbiAgICAgICAgICAgIGBcInJlcXVpcmVqcy1jb25maWcuanNcIiBmb3IgdGhlbWUgXCIke3RoZW1lSUR9XCJgLFxuICAgICk7XG59XG4iXX0=