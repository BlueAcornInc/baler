"use strict";
/**
 * Copyright Â© Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fsPromises_1 = require("./fsPromises");
const fs_1 = require("fs");
const path_1 = require("path");
const fast_glob_1 = __importDefault(require("fast-glob"));
// @ts-ignore
const glob_1 = __importDefault(require("glob"));
const flatten_1 = require("./flatten");
const fromentries_1 = __importDefault(require("fromentries"));
const fast_xml_parser_1 = require("fast-xml-parser");
const findUp_1 = require("./findUp");
const magentoInterop_1 = require("./magentoInterop");
const BalerError_1 = require("./BalerError");
const trace_1 = require("./trace");
const parseTemplateDeps_1 = require("./parseTemplateDeps");
/**
 * @summary Verify all the dirs we need from Magento are available.
 *          Things to be checked should be kept to the essentials
 *          (see: https://github.com/magento/baler/issues/30)
 */
async function findMagentoRoot(dir) {
    trace_1.trace(`looking for magento root starting at ${dir}`);
    const EXPECTED_ENTRIES = ['app', 'vendor', 'pub'];
    const predicate = (dir, entries) => {
        return EXPECTED_ENTRIES.every(e => entries.includes(e));
    };
    return findUp_1.findUp(dir, predicate);
}
exports.findMagentoRoot = findMagentoRoot;
/**
 * @summary Get a list of names for all enabled modules.
 *          We _could_ use a full PHP parser here to be safe,
 *          but `app/etc/config.php` is codegen'd, so the odds
 *          of it not following very specific conventions is small
 */
async function getEnabledModules(magentoRoot) {
    trace_1.trace('reading enabled modules from app/etc/config.php');
    const configPath = path_1.join(magentoRoot, 'app/etc/config.php');
    const rawConfig = await fsPromises_1.readFile(configPath, 'utf8').catch(() => '');
    if (!rawConfig) {
        throw new BalerError_1.BalerError(`Failed to read list of enabled modules from ${configPath}`);
    }
    const [, rawArrayBody = ''] = rawConfig.match(/'modules'\s*=>\s*\[(.+)\]/s) || [];
    const items = rawArrayBody.split(',').map(t => t.trim());
    const enabledModules = [];
    for (const item of items) {
        const [, name = '', enabledStr = ''] = item.match(/'(\w+)'\s*=>\s*([01])/) || [];
        if (name && Number(enabledStr))
            enabledModules.push(name);
    }
    trace_1.trace(`enabled modules: ${JSON.stringify(enabledModules)}`);
    return enabledModules;
}
exports.getEnabledModules = getEnabledModules;
async function getComponents(magentoRoot) {
    const componentPaths = await magentoInterop_1.getModulesAndThemesFromMagento(magentoRoot);
    return {
        themes: await getThemesFromPaths(componentPaths.themes),
        modules: getModulesFromPaths(componentPaths.modules),
    };
}
exports.getComponents = getComponents;
async function getThemesFromPaths(themePaths) {
    const pendingThemes = Object.entries(themePaths).map(async ([fullID, path]) => {
        const [area, vendor, name] = fullID.split('/');
        const themeID = `${vendor}/${name}`;
        const theme = {
            name,
            vendor,
            area: area,
            themeID,
            path,
            parentID: await getThemeParentName(path),
        };
        return [themeID, theme];
    });
    return fromentries_1.default(await Promise.all(pendingThemes));
}
function getModulesFromPaths(modulePaths) {
    return fromentries_1.default(Object.entries(modulePaths).map(([moduleID, path]) => {
        const mod = {
            moduleID,
            path: path,
        };
        return [moduleID, mod];
    }));
}
/**
 * @summary Get a list of all _deployed_ frontend and adminhtml themes
 *          for all vendors
 */
async function getDeployedThemes(magentoRoot) {
    trace_1.trace('checking pub/static for deployed themes');
    const staticRoot = path_1.join(magentoRoot, 'pub', 'static');
    const [frontendVendors, adminVendors] = await Promise.all([
        getDirEntriesAtPath(path_1.join(staticRoot, 'frontend')),
        getDirEntriesAtPath(path_1.join(staticRoot, 'adminhtml')),
    ]);
    const pendingFrontendThemes = Promise.all(frontendVendors.map(v => getDeployedThemesForVendor(magentoRoot, 'frontend', v)));
    const pendingAdminThemes = Promise.all(adminVendors.map(v => getDeployedThemesForVendor(magentoRoot, 'adminhtml', v)));
    const [frontendThemes, adminThemes] = await Promise.all([
        pendingFrontendThemes,
        pendingAdminThemes,
    ]);
    const deployedThemes = [
        ...flatten_1.flatten(frontendThemes),
        ...flatten_1.flatten(adminThemes),
    ];
    trace_1.trace(`found deployed themes: ${deployedThemes}`);
    return deployedThemes;
}
exports.getDeployedThemes = getDeployedThemes;
/**
 * @summary Get an unordered list of all .phtml files for a specific
 *          area (frontend/adminhtml/base) for enabled modules only
 * @todo Switch from fast-glob to manual recursive crawling of the fs.
 *       Globbing has too much of a perf penalty
 */
async function getPHTMLFilesEligibleForUseWithTheme(themeHierarchy, enabledModules, modules) {
    const moduleGlobs = enabledModules.map(moduleID => {
        const mod = modules[moduleID];
        return path_1.join(mod.path, 'view', `{${themeHierarchy[0].area},base}`, 'templates', '**/*.phtml');
    });
    const themeGlobs = flatten_1.flatten(enabledModules.map(m => {
        return themeHierarchy.map(t => `${t.path}/${m}/templates/**/*.phtml`);
    }));
    return fast_glob_1.default([...moduleGlobs, ...themeGlobs], {
        onlyFiles: true,
    });
}
exports.getPHTMLFilesEligibleForUseWithTheme = getPHTMLFilesEligibleForUseWithTheme;
async function getLayoutFilesEligibleForUseWithTheme(themeHierarchy, enabledModules, modules) {
    const promises = [];
    const globbyCallback = (resolve, reject) => (err, files) => {
        if (err) {
            console.log(err);
            reject(err);
        }
        else {
            console.log(files);
            resolve(files);
        }
    };
    for (const enabledModule of enabledModules) {
        const mod = modules[enabledModule];
        if (mod) {
            promises.push(new Promise((resolve, reject) => {
                glob_1.default(path_1.join(mod.path, 'view', themeHierarchy[0].area, 'layout', '*.xml'), globbyCallback(resolve, reject));
            }));
            promises.push(new Promise((resolve, reject) => {
                glob_1.default(path_1.join(mod.path, 'view', 'base', 'layout', '*.xml'), globbyCallback(resolve, reject));
            }));
            for (const theme of themeHierarchy) {
                promises.push(new Promise((resolve, reject) => {
                    glob_1.default(path_1.join(theme.path, enabledModule, 'layout', '*.xml'), globbyCallback(resolve, reject));
                }));
            }
        }
    }
    const filePaths = await Promise.all(promises);
    let allPaths = [];
    for (const filePathsArray of filePaths) {
        // @ts-ignore
        allPaths = allPaths.concat(filePathsArray);
    }
    return allPaths;
}
exports.getLayoutFilesEligibleForUseWithTheme = getLayoutFilesEligibleForUseWithTheme;
;
async function getPHTMLFilesFromLayoutHandle(layoutFile, themeHierarchy, modules) {
    const templates = [];
    // Read layout file
    const layoutXml = await fsPromises_1.readFile(layoutFile, 'utf8').catch(() => '');
    // Get phtml files
    let matches = layoutXml.match(/template="(.*?)"/g);
    if (matches) {
        const matchesArray = matches.map(match => match.match(/"(.*?)"/));
        for (const match of matchesArray) {
            if (match instanceof Array) {
                templates.push(match[1]);
            }
        }
    }
    // Convert phtml files into file paths
    return templates
        // Fully qualified only
        .filter(template => template.split('::').length > 1)
        // Resolve path
        .map(template => {
        const [moduleName, file] = template.split('::');
        const fallbackPaths = themeHierarchy
            .map(theme => `${theme.path}/${moduleName}/templates/${file}`);
        fallbackPaths.push(`${modules[moduleName].path}/view/${themeHierarchy[0].area}/templates/${file}`);
        fallbackPaths.push(`${modules[moduleName].path}/view/base/templates/${file}`);
        for (const fallback of fallbackPaths) {
            try {
                const found = fs_1.statSync(fallback);
                return fallback;
            }
            catch (err) { }
        }
        return '';
    })
        // Remove templates that we couldn't find
        .filter((template) => template.length > 0);
}
exports.getPHTMLFilesFromLayoutHandle = getPHTMLFilesFromLayoutHandle;
;
async function getDepsFromPHTMLPath(templateFile) {
    const templateContent = await fsPromises_1.readFile(templateFile, 'utf8').catch(() => '');
    const { deps } = parseTemplateDeps_1.parseTemplateDeps(templateContent);
    return deps || [];
}
exports.getDepsFromPHTMLPath = getDepsFromPHTMLPath;
async function getLocalesForDeployedTheme(magentoRoot, theme) {
    trace_1.trace(`fetching deployed locales for ${theme.themeID}`);
    const themeRoot = path_1.join(magentoRoot, getStaticDirForTheme(theme));
    const dirs = await getDirEntriesAtPath(themeRoot);
    // filter out any extra files/folders that aren't locales
    const reLang = /^[a-z]{2}(?:_[a-z]{2})?$/i;
    const locales = dirs.filter(d => reLang.test(d));
    trace_1.trace(`found deployed locales for ${theme.themeID}: ${JSON.stringify(locales)}`);
    return locales;
}
exports.getLocalesForDeployedTheme = getLocalesForDeployedTheme;
function getStaticDirForTheme(theme) {
    // Can't use `vendor` prop from Theme, because the casing
    // might be different. Magento always uses the theme ID when
    // writing to `pub/static`. We have to split here, though,
    // so that *nix path separators don't make it in (need windows compat)
    const [vendor, name] = theme.themeID.split('/');
    return path_1.join('pub', 'static', theme.area, vendor, name);
}
exports.getStaticDirForTheme = getStaticDirForTheme;
async function getThemeParentName(themePath) {
    trace_1.trace(`checking for parent of theme at ${themePath}`);
    const themeXMLPath = path_1.join(themePath, 'theme.xml');
    const source = await fsPromises_1.readFile(themeXMLPath, 'utf8').catch(() => '');
    if (!source) {
        throw new BalerError_1.BalerError(`Could not find theme configuration (theme.xml) for theme at "${themeXMLPath}"`);
    }
    const parsedThemeConfig = fast_xml_parser_1.parse(source, {
        ignoreAttributes: false,
        attributeNamePrefix: '',
        ignoreNameSpace: true,
    });
    const parent = parsedThemeConfig.theme.parent || '';
    trace_1.trace(parent
        ? `found parent of ${parent} for theme at ${themePath}`
        : `no parent found for theme at path ${themePath}`);
    return parent;
}
async function getDeployedThemesForVendor(magentoRoot, area, vendor) {
    const vendorPath = path_1.join(magentoRoot, 'pub', 'static', area, vendor);
    const vendorEntries = await getDirEntriesAtPath(vendorPath);
    const themeNames = vendorEntries.filter(e => /^[a-zA-Z0-9-_]+$/.test(e));
    return themeNames.map(name => `${vendor}/${name}`);
}
const getDirEntriesAtPath = (path) => fsPromises_1.readdir(path, { withFileTypes: true })
    .then(entries => entries.filter(d => d.isDirectory()).map(d => d.name))
    .catch(() => []);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFnZW50b0ZTLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL21hZ2VudG9GUy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7OztBQUVILDZDQUFpRDtBQUNqRCwyQkFBOEI7QUFDOUIsK0JBQTRCO0FBQzVCLDBEQUE2QjtBQUM3QixhQUFhO0FBQ2IsZ0RBQTBDO0FBQzFDLHVDQUFvQztBQUVwQyw4REFBc0M7QUFDdEMscURBQW9EO0FBQ3BELHFDQUFrQztBQUNsQyxxREFBa0U7QUFDbEUsNkNBQTBDO0FBQzFDLG1DQUFnQztBQUNoQywyREFBd0Q7QUFFeEQ7Ozs7R0FJRztBQUNJLEtBQUssVUFBVSxlQUFlLENBQUMsR0FBVztJQUM3QyxhQUFLLENBQUMsd0NBQXdDLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDckQsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDbEQsTUFBTSxTQUFTLEdBQUcsQ0FBQyxHQUFXLEVBQUUsT0FBaUIsRUFBRSxFQUFFO1FBQ2pELE9BQU8sZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzVELENBQUMsQ0FBQztJQUVGLE9BQU8sZUFBTSxDQUFDLEdBQUcsRUFBRSxTQUFTLENBQUMsQ0FBQztBQUNsQyxDQUFDO0FBUkQsMENBUUM7QUFFRDs7Ozs7R0FLRztBQUNJLEtBQUssVUFBVSxpQkFBaUIsQ0FBQyxXQUFtQjtJQUN2RCxhQUFLLENBQUMsaURBQWlELENBQUMsQ0FBQztJQUN6RCxNQUFNLFVBQVUsR0FBRyxXQUFJLENBQUMsV0FBVyxFQUFFLG9CQUFvQixDQUFDLENBQUM7SUFDM0QsTUFBTSxTQUFTLEdBQUcsTUFBTSxxQkFBUSxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFF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Q0FBQyxDQUFDLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUV6RSxPQUFPLFVBQVUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBQ3ZELENBQUM7QUFFRCxNQUFNLG1CQUFtQixHQUFHLENBQUMsSUFBWSxFQUFFLEVBQUUsQ0FDekMsb0JBQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUM7S0FDakMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUN0RSxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBYyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCDCqSBNYWdlbnRvLCBJbmMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBTZWUgQ09QWUlORy50eHQgZm9yIGxpY2Vuc2UgZGV0YWlscy5cbiAqL1xuXG5pbXBvcnQgeyByZWFkRmlsZSwgcmVhZGRpciB9IGZyb20gJy4vZnNQcm9taXNlcyc7XG5pbXBvcnQgeyBzdGF0U3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCBnbG9iIGZyb20gJ2Zhc3QtZ2xvYic7XG4vLyBAdHMtaWdub3JlXG5pbXBvcnQgZ2xvYlRoYXRXb3Jrc1dpdGhDbG91ZCBmcm9tICdnbG9iJztcbmltcG9ydCB7IGZsYXR0ZW4gfSBmcm9tICcuL2ZsYXR0ZW4nO1xuaW1wb3J0IHsgVGhlbWUsIENvbXBvbmVudHMsIE1vZHVsZSwgQ29tcG9uZW50UGF0aHMgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCBmcm9tRW50cmllcyBmcm9tICdmcm9tZW50cmllcyc7XG5pbXBvcnQgeyBwYXJzZSBhcyBwYXJzZVhNTCB9IGZyb20gJ2Zhc3QteG1sLXBhcnNlcic7XG5pbXBvcnQgeyBmaW5kVXAgfSBmcm9tICcuL2ZpbmRVcCc7XG5pbXBvcnQgeyBnZXRNb2R1bGVzQW5kVGhlbWVzRnJvbU1hZ2VudG8gfSBmcm9tICcuL21hZ2VudG9JbnRlcm9wJztcbmltcG9ydCB7IEJhbGVyRXJyb3IgfSBmcm9tICcuL0JhbGVyRXJyb3InO1xuaW1wb3J0IHsgdHJhY2UgfSBmcm9tICcuL3RyYWNlJztcbmltcG9ydCB7IHBhcnNlVGVtcGxhdGVEZXBzIH0gZnJvbSAnLi9wYXJzZVRlbXBsYXRlRGVwcyc7XG5cbi8qKlxuICogQHN1bW1hcnkgVmVyaWZ5IGFsbCB0aGUgZGlycyB3ZSBuZWVkIGZyb20gTWFnZW50byBhcmUgYXZhaWxhYmxlLlxuICogICAgICAgICAgVGhpbmdzIHRvIGJlIGNoZWNrZWQgc2hvdWxkIGJlIGtlcHQgdG8gdGhlIGVzc2VudGlhbHNcbiAqICAgICAgICAgIChzZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9tYWdlbnRvL2JhbGVyL2lzc3Vlcy8zMClcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZpbmRNYWdlbnRvUm9vdChkaXI6IHN0cmluZykge1xuICAgIHRyYWNlKGBsb29raW5nIGZvciBtYWdlbnRvIHJvb3Qgc3RhcnRpbmcgYXQgJHtkaXJ9YCk7XG4gICAgY29uc3QgRVhQRUNURURfRU5UUklFUyA9IFsnYXBwJywgJ3ZlbmRvcicsICdwdWInXTtcbiAgICBjb25zdCBwcmVkaWNhdGUgPSAoZGlyOiBzdHJpbmcsIGVudHJpZXM6IHN0cmluZ1tdKSA9PiB7XG4gICAgICAgIHJldHVybiBFWFBFQ1RFRF9FTlRSSUVTLmV2ZXJ5KGUgPT4gZW50cmllcy5pbmNsdWRlcyhlKSk7XG4gICAgfTtcblxuICAgIHJldHVybiBmaW5kVXAoZGlyLCBwcmVkaWNhdGUpO1xufVxuXG4vKipcbiAqIEBzdW1tYXJ5IEdldCBhIGxpc3Qgb2YgbmFtZXMgZm9yIGFsbCBlbmFibGVkIG1vZHVsZXMuXG4gKiAgICAgICAgICBXZSBfY291bGRfIHVzZSBhIGZ1bGwgUEhQIHBhcnNlciBoZXJlIHRvIGJlIHNhZmUsXG4gKiAgICAgICAgICBidXQgYGFwcC9ldGMvY29uZmlnLnBocGAgaXMgY29kZWdlbidkLCBzbyB0aGUgb2Rkc1xuICogICAgICAgICAgb2YgaXQgbm90IGZvbGxvd2luZyB2ZXJ5IHNwZWNpZmljIGNvbnZlbnRpb25zIGlzIHNtYWxsXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRFbmFibGVkTW9kdWxlcyhtYWdlbnRvUm9vdDogc3RyaW5nKSB7XG4gICAgdHJhY2UoJ3JlYWRpbmcgZW5hYmxlZCBtb2R1bGVzIGZyb20gYXBwL2V0Yy9jb25maWcucGhwJyk7XG4gICAgY29uc3QgY29uZmlnUGF0aCA9IGpvaW4obWFnZW50b1Jvb3QsICdhcHAvZXRjL2NvbmZpZy5waHAnKTtcbiAgICBjb25zdCByYXdDb25maWcgPSBhd2FpdCByZWFkRmlsZShjb25maWdQYXRoLCAndXRmOCcpLmNhdGNoKCgpID0+ICcnKTtcbiAgICBpZiAoIXJhd0NvbmZpZykge1xuICAgICAgICB0aHJvdyBuZXcgQmFsZXJFcnJvcihcbiAgICAgICAgICAgIGBGYWlsZWQgdG8gcmVhZCBsaXN0IG9mIGVuYWJsZWQgbW9kdWxlcyBmcm9tICR7Y29uZmlnUGF0aH1gLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IFssIHJhd0FycmF5Qm9keSA9ICcnXSA9XG4gICAgICAgIHJhd0NvbmZpZy5tYXRjaCgvJ21vZHVsZXMnXFxzKj0+XFxzKlxcWyguKylcXF0vcykgfHwgW107XG4gICAgY29uc3QgaXRlbXMgPSByYXdBcnJheUJvZHkuc3BsaXQoJywnKS5tYXAodCA9PiB0LnRyaW0oKSk7XG5cbiAgICBjb25zdCBlbmFibGVkTW9kdWxlczogc3RyaW5nW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgaXRlbXMpIHtcbiAgICAgICAgY29uc3QgWywgbmFtZSA9ICcnLCBlbmFibGVkU3RyID0gJyddID1cbiAgICAgICAgICAgIGl0ZW0ubWF0Y2goLycoXFx3KyknXFxzKj0+XFxzKihbMDFdKS8pIHx8IFtdO1xuICAgICAgICBpZiAobmFtZSAmJiBOdW1iZXIoZW5hYmxlZFN0cikpIGVuYWJsZWRNb2R1bGVzLnB1c2gobmFtZSk7XG4gICAgfVxuXG4gICAgdHJhY2UoYGVuYWJsZWQgbW9kdWxlczogJHtKU09OLnN0cmluZ2lmeShlbmFibGVkTW9kdWxlcyl9YCk7XG4gICAgcmV0dXJuIGVuYWJsZWRNb2R1bGVzO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0Q29tcG9uZW50cyhtYWdlbnRvUm9vdDogc3RyaW5nKTogUHJvbWlzZTxDb21wb25lbnRzPiB7XG4gICAgY29uc3QgY29tcG9uZW50UGF0aHMgPSBhd2FpdCBnZXRNb2R1bGVzQW5kVGhlbWVzRnJvbU1hZ2VudG8obWFnZW50b1Jvb3QpO1xuICAgIHJldHVybiB7XG4gICAgICAgIHRoZW1lczogYXdhaXQgZ2V0VGhlbWVzRnJvbVBhdGhzKGNvbXBvbmVudFBhdGhzLnRoZW1lcyksXG4gICAgICAgIG1vZHVsZXM6IGdldE1vZHVsZXNGcm9tUGF0aHMoY29tcG9uZW50UGF0aHMubW9kdWxlcyksXG4gICAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0VGhlbWVzRnJvbVBhdGhzKFxuICAgIHRoZW1lUGF0aHM6IENvbXBvbmVudFBhdGhzWyd0aGVtZXMnXSxcbik6IFByb21pc2U8UmVjb3JkPHN0cmluZywgVGhlbWU+PiB7XG4gICAgY29uc3QgcGVuZGluZ1RoZW1lczogUHJvbWlzZTxbc3RyaW5nLCBUaGVtZV0+W10gPSBPYmplY3QuZW50cmllcyhcbiAgICAgICAgdGhlbWVQYXRocyxcbiAgICApLm1hcChhc3luYyAoW2Z1bGxJRCwgcGF0aF0pID0+IHtcbiAgICAgICAgY29uc3QgW2FyZWEsIHZlbmRvciwgbmFtZV0gPSBmdWxsSUQuc3BsaXQoJy8nKTtcbiAgICAgICAgY29uc3QgdGhlbWVJRCA9IGAke3ZlbmRvcn0vJHtuYW1lfWA7XG4gICAgICAgIGNvbnN0IHRoZW1lOiBUaGVtZSA9IHtcbiAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICB2ZW5kb3IsXG4gICAgICAgICAgICBhcmVhOiBhcmVhIGFzIFRoZW1lWydhcmVhJ10sXG4gICAgICAgICAgICB0aGVtZUlELFxuICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgIHBhcmVudElEOiBhd2FpdCBnZXRUaGVtZVBhcmVudE5hbWUocGF0aCksXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBbdGhlbWVJRCwgdGhlbWVdIGFzIFtzdHJpbmcsIFRoZW1lXTtcbiAgICB9KTtcbiAgICByZXR1cm4gZnJvbUVudHJpZXMoYXdhaXQgUHJvbWlzZS5hbGwocGVuZGluZ1RoZW1lcykpO1xufVxuXG5mdW5jdGlvbiBnZXRNb2R1bGVzRnJvbVBhdGhzKFxuICAgIG1vZHVsZVBhdGhzOiBDb21wb25lbnRQYXRoc1snbW9kdWxlcyddLFxuKTogUmVjb3JkPHN0cmluZywgTW9kdWxlPiB7XG4gICAgcmV0dXJuIGZyb21FbnRyaWVzKFxuICAgICAgICBPYmplY3QuZW50cmllcyhtb2R1bGVQYXRocykubWFwKChbbW9kdWxlSUQsIHBhdGhdKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtb2Q6IE1vZHVsZSA9IHtcbiAgICAgICAgICAgICAgICBtb2R1bGVJRCxcbiAgICAgICAgICAgICAgICBwYXRoOiBwYXRoLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHJldHVybiBbbW9kdWxlSUQsIG1vZF0gYXMgW3N0cmluZywgTW9kdWxlXTtcbiAgICAgICAgfSksXG4gICAgKTtcbn1cblxuLyoqXG4gKiBAc3VtbWFyeSBHZXQgYSBsaXN0IG9mIGFsbCBfZGVwbG95ZWRfIGZyb250ZW5kIGFuZCBhZG1pbmh0bWwgdGhlbWVzXG4gKiAgICAgICAgICBmb3IgYWxsIHZlbmRvcnNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldERlcGxveWVkVGhlbWVzKFxuICAgIG1hZ2VudG9Sb290OiBzdHJpbmcsXG4pOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgdHJhY2UoJ2NoZWNraW5nIHB1Yi9zdGF0aWMgZm9yIGRlcGxveWVkIHRoZW1lcycpO1xuICAgIGNvbnN0IHN0YXRpY1Jvb3QgPSBqb2luKG1hZ2VudG9Sb290LCAncHViJywgJ3N0YXRpYycpO1xuXG4gICAgY29uc3QgW2Zyb250ZW5kVmVuZG9ycywgYWRtaW5WZW5kb3JzXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgZ2V0RGlyRW50cmllc0F0UGF0aChqb2luKHN0YXRpY1Jvb3QsICdmcm9udGVuZCcpKSxcbiAgICAgICAgZ2V0RGlyRW50cmllc0F0UGF0aChqb2luKHN0YXRpY1Jvb3QsICdhZG1pbmh0bWwnKSksXG4gICAgXSk7XG5cbiAgICBjb25zdCBwZW5kaW5nRnJvbnRlbmRUaGVtZXMgPSBQcm9taXNlLmFsbChcbiAgICAgICAgZnJvbnRlbmRWZW5kb3JzLm1hcCh2ID0+XG4gICAgICAgICAgICBnZXREZXBsb3llZFRoZW1lc0ZvclZlbmRvcihtYWdlbnRvUm9vdCwgJ2Zyb250ZW5kJywgdiksXG4gICAgICAgICksXG4gICAgKTtcbiAgICBjb25zdCBwZW5kaW5nQWRtaW5UaGVtZXMgPSBQcm9taXNlLmFsbChcbiAgICAgICAgYWRtaW5WZW5kb3JzLm1hcCh2ID0+XG4gICAgICAgICAgICBnZXREZXBsb3llZFRoZW1lc0ZvclZlbmRvcihtYWdlbnRvUm9vdCwgJ2FkbWluaHRtbCcsIHYpLFxuICAgICAgICApLFxuICAgICk7XG5cbiAgICBjb25zdCBbZnJvbnRlbmRUaGVtZXMsIGFkbWluVGhlbWVzXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgcGVuZGluZ0Zyb250ZW5kVGhlbWVzLFxuICAgICAgICBwZW5kaW5nQWRtaW5UaGVtZXMsXG4gICAgXSk7XG5cbiAgICBjb25zdCBkZXBsb3llZFRoZW1lcyA9IFtcbiAgICAgICAgLi4uZmxhdHRlbihmcm9udGVuZFRoZW1lcyksXG4gICAgICAgIC4uLmZsYXR0ZW4oYWRtaW5UaGVtZXMpLFxuICAgIF07XG4gICAgdHJhY2UoYGZvdW5kIGRlcGxveWVkIHRoZW1lczogJHtkZXBsb3llZFRoZW1lc31gKTtcbiAgICByZXR1cm4gZGVwbG95ZWRUaGVtZXM7XG59XG5cbi8qKlxuICogQHN1bW1hcnkgR2V0IGFuIHVub3JkZXJlZCBsaXN0IG9mIGFsbCAucGh0bWwgZmlsZXMgZm9yIGEgc3BlY2lmaWNcbiAqICAgICAgICAgIGFyZWEgKGZyb250ZW5kL2FkbWluaHRtbC9iYXNlKSBmb3IgZW5hYmxlZCBtb2R1bGVzIG9ubHlcbiAqIEB0b2RvIFN3aXRjaCBmcm9tIGZhc3QtZ2xvYiB0byBtYW51YWwgcmVjdXJzaXZlIGNyYXdsaW5nIG9mIHRoZSBmcy5cbiAqICAgICAgIEdsb2JiaW5nIGhhcyB0b28gbXVjaCBvZiBhIHBlcmYgcGVuYWx0eVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UEhUTUxGaWxlc0VsaWdpYmxlRm9yVXNlV2l0aFRoZW1lKFxuICAgIHRoZW1lSGllcmFyY2h5OiBUaGVtZVtdLFxuICAgIGVuYWJsZWRNb2R1bGVzOiBzdHJpbmdbXSxcbiAgICBtb2R1bGVzOiBSZWNvcmQ8c3RyaW5nLCBNb2R1bGU+LFxuKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IG1vZHVsZUdsb2JzID0gZW5hYmxlZE1vZHVsZXMubWFwKG1vZHVsZUlEID0+IHtcbiAgICAgICAgY29uc3QgbW9kID0gbW9kdWxlc1ttb2R1bGVJRF07XG4gICAgICAgIHJldHVybiBqb2luKFxuICAgICAgICAgICAgbW9kLnBhdGgsXG4gICAgICAgICAgICAndmlldycsXG4gICAgICAgICAgICBgeyR7dGhlbWVIaWVyYXJjaHlbMF0uYXJlYX0sYmFzZX1gLFxuICAgICAgICAgICAgJ3RlbXBsYXRlcycsXG4gICAgICAgICAgICAnKiovKi5waHRtbCcsXG4gICAgICAgICk7XG4gICAgfSk7XG5cbiAgICBjb25zdCB0aGVtZUdsb2JzID0gZmxhdHRlbihcbiAgICAgICAgZW5hYmxlZE1vZHVsZXMubWFwKG0gPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHRoZW1lSGllcmFyY2h5Lm1hcChcbiAgICAgICAgICAgICAgICB0ID0+IGAke3QucGF0aH0vJHttfS90ZW1wbGF0ZXMvKiovKi5waHRtbGAsXG4gICAgICAgICAgICApO1xuICAgICAgICB9KSxcbiAgICApO1xuXG4gICAgcmV0dXJuIGdsb2IoWy4uLm1vZHVsZUdsb2JzLCAuLi50aGVtZUdsb2JzXSwge1xuICAgICAgICBvbmx5RmlsZXM6IHRydWUsXG4gICAgfSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRMYXlvdXRGaWxlc0VsaWdpYmxlRm9yVXNlV2l0aFRoZW1lKFxuICAgIHRoZW1lSGllcmFyY2h5OiBUaGVtZVtdLFxuICAgIGVuYWJsZWRNb2R1bGVzOiBzdHJpbmdbXSxcbiAgICBtb2R1bGVzOiBSZWNvcmQ8c3RyaW5nLCBNb2R1bGU+LFxuKSB7XG4gICAgY29uc3QgcHJvbWlzZXMgPSBbXTtcblxuICAgIGNvbnN0IGdsb2JieUNhbGxiYWNrID0gKHJlc29sdmU6IEZ1bmN0aW9uLCByZWplY3Q6IEZ1bmN0aW9uKSA9PiAoZXJyOiBzdHJpbmcsIGZpbGVzOiBzdHJpbmdbXSkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xuICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhmaWxlcyk7XG4gICAgICAgICAgICByZXNvbHZlKGZpbGVzKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBmb3IgKGNvbnN0IGVuYWJsZWRNb2R1bGUgb2YgZW5hYmxlZE1vZHVsZXMpIHtcbiAgICAgICAgY29uc3QgbW9kID0gbW9kdWxlc1tlbmFibGVkTW9kdWxlXTtcbiAgICAgICAgaWYgKG1vZCkge1xuICAgICAgICAgICAgcHJvbWlzZXMucHVzaChcbiAgICAgICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGdsb2JUaGF0V29ya3NXaXRoQ2xvdWQoXG4gICAgICAgICAgICAgICAgICAgICAgICBqb2luKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZC5wYXRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd2aWV3JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVtZUhpZXJhcmNoeVswXS5hcmVhLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYXlvdXQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICcqLnhtbCdcbiAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICBnbG9iYnlDYWxsYmFjayhyZXNvbHZlLCByZWplY3QpXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgcHJvbWlzZXMucHVzaChcbiAgICAgICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGdsb2JUaGF0V29ya3NXaXRoQ2xvdWQoXG4gICAgICAgICAgICAgICAgICAgICAgICBqb2luKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZC5wYXRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd2aWV3JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYmFzZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xheW91dCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJyoueG1sJ1xuICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JieUNhbGxiYWNrKHJlc29sdmUsIHJlamVjdClcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgdGhlbWUgb2YgdGhlbWVIaWVyYXJjaHkpIHtcbiAgICAgICAgICAgICAgICBwcm9taXNlcy5wdXNoKFxuICAgICAgICAgICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBnbG9iVGhhdFdvcmtzV2l0aENsb3VkKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpvaW4oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZW1lLnBhdGgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuYWJsZWRNb2R1bGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYXlvdXQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnKi54bWwnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnbG9iYnlDYWxsYmFjayhyZXNvbHZlLCByZWplY3QpXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGZpbGVQYXRocyA9IGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgICBsZXQgYWxsUGF0aHM6IHN0cmluZ1tdID0gW107XG5cbiAgICBmb3IgKGNvbnN0IGZpbGVQYXRoc0FycmF5IG9mIGZpbGVQYXRocykge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGFsbFBhdGhzID0gYWxsUGF0aHMuY29uY2F0KGZpbGVQYXRoc0FycmF5KTtcbiAgICB9XG5cbiAgICByZXR1cm4gYWxsUGF0aHM7XG59O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UEhUTUxGaWxlc0Zyb21MYXlvdXRIYW5kbGUoXG4gICAgbGF5b3V0RmlsZTogc3RyaW5nLFxuICAgIHRoZW1lSGllcmFyY2h5OiBUaGVtZVtdLFxuICAgIG1vZHVsZXM6IFJlY29yZDxzdHJpbmcsIE1vZHVsZT5cbik6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCB0ZW1wbGF0ZXMgPSBbXTtcbiAgICAvLyBSZWFkIGxheW91dCBmaWxlXG4gICAgY29uc3QgbGF5b3V0WG1sID0gYXdhaXQgcmVhZEZpbGUobGF5b3V0RmlsZSwgJ3V0ZjgnKS5jYXRjaCgoKSA9PiAnJyk7XG4gICAgLy8gR2V0IHBodG1sIGZpbGVzXG4gICAgbGV0IG1hdGNoZXMgPSBsYXlvdXRYbWwubWF0Y2goL3RlbXBsYXRlPVwiKC4qPylcIi9nKTtcbiAgICBpZiAobWF0Y2hlcykge1xuICAgICAgICBjb25zdCBtYXRjaGVzQXJyYXkgPSBtYXRjaGVzLm1hcChtYXRjaCA9PiBtYXRjaC5tYXRjaCgvXCIoLio/KVwiLykpO1xuICAgICAgICBmb3IgKGNvbnN0IG1hdGNoIG9mIG1hdGNoZXNBcnJheSkge1xuICAgICAgICAgICAgaWYgKG1hdGNoIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZXMucHVzaChtYXRjaFsxXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgLy8gQ29udmVydCBwaHRtbCBmaWxlcyBpbnRvIGZpbGUgcGF0aHNcbiAgICByZXR1cm4gdGVtcGxhdGVzXG4gICAgICAgIC8vIEZ1bGx5IHF1YWxpZmllZCBvbmx5XG4gICAgICAgIC5maWx0ZXIodGVtcGxhdGUgPT4gdGVtcGxhdGUuc3BsaXQoJzo6JykubGVuZ3RoID4gMSlcbiAgICAgICAgLy8gUmVzb2x2ZSBwYXRoXG4gICAgICAgIC5tYXAodGVtcGxhdGUgPT4ge1xuICAgICAgICAgICAgY29uc3QgW21vZHVsZU5hbWUsIGZpbGVdID0gdGVtcGxhdGUuc3BsaXQoJzo6Jyk7XG4gICAgICAgICAgICBjb25zdCBmYWxsYmFja1BhdGhzID0gdGhlbWVIaWVyYXJjaHlcbiAgICAgICAgICAgICAgICAubWFwKHRoZW1lID0+IGAke3RoZW1lLnBhdGh9LyR7bW9kdWxlTmFtZX0vdGVtcGxhdGVzLyR7ZmlsZX1gKTtcbiAgICAgICAgICAgIGZhbGxiYWNrUGF0aHMucHVzaChgJHttb2R1bGVzW21vZHVsZU5hbWVdLnBhdGh9L3ZpZXcvJHt0aGVtZUhpZXJhcmNoeVswXS5hcmVhfS90ZW1wbGF0ZXMvJHtmaWxlfWApO1xuICAgICAgICAgICAgZmFsbGJhY2tQYXRocy5wdXNoKGAke21vZHVsZXNbbW9kdWxlTmFtZV0ucGF0aH0vdmlldy9iYXNlL3RlbXBsYXRlcy8ke2ZpbGV9YCk7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgZmFsbGJhY2sgb2YgZmFsbGJhY2tQYXRocykge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvdW5kID0gc3RhdFN5bmMoZmFsbGJhY2spO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsbGJhY2s7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7fVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gJydcbiAgICAgICAgfSlcbiAgICAgICAgLy8gUmVtb3ZlIHRlbXBsYXRlcyB0aGF0IHdlIGNvdWxkbid0IGZpbmRcbiAgICAgICAgLmZpbHRlcigodGVtcGxhdGUpID0+IHRlbXBsYXRlLmxlbmd0aCA+IDApO1xufTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldERlcHNGcm9tUEhUTUxQYXRoKFxuICAgIHRlbXBsYXRlRmlsZTogc3RyaW5nXG4pOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgdGVtcGxhdGVDb250ZW50ID0gYXdhaXQgcmVhZEZpbGUodGVtcGxhdGVGaWxlLCAndXRmOCcpLmNhdGNoKCgpID0+ICcnKTtcbiAgICBjb25zdCB7IGRlcHMgfSA9IHBhcnNlVGVtcGxhdGVEZXBzKHRlbXBsYXRlQ29udGVudCk7XG5cbiAgICByZXR1cm4gZGVwcyB8fCBbXTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldExvY2FsZXNGb3JEZXBsb3llZFRoZW1lKFxuICAgIG1hZ2VudG9Sb290OiBzdHJpbmcsXG4gICAgdGhlbWU6IFRoZW1lLFxuKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHRyYWNlKGBmZXRjaGluZyBkZXBsb3llZCBsb2NhbGVzIGZvciAke3RoZW1lLnRoZW1lSUR9YCk7XG4gICAgY29uc3QgdGhlbWVSb290ID0gam9pbihtYWdlbnRvUm9vdCwgZ2V0U3RhdGljRGlyRm9yVGhlbWUodGhlbWUpKTtcbiAgICBjb25zdCBkaXJzID0gYXdhaXQgZ2V0RGlyRW50cmllc0F0UGF0aCh0aGVtZVJvb3QpO1xuXG4gICAgLy8gZmlsdGVyIG91dCBhbnkgZXh0cmEgZmlsZXMvZm9sZGVycyB0aGF0IGFyZW4ndCBsb2NhbGVzXG4gICAgY29uc3QgcmVMYW5nID0gL15bYS16XXsyfSg/Ol9bYS16XXsyfSk/JC9pO1xuICAgIGNvbnN0IGxvY2FsZXMgPSBkaXJzLmZpbHRlcihkID0+IHJlTGFuZy50ZXN0KGQpKTtcbiAgICB0cmFjZShcbiAgICAgICAgYGZvdW5kIGRlcGxveWVkIGxvY2FsZXMgZm9yICR7dGhlbWUudGhlbWVJRH06ICR7SlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAgICBsb2NhbGVzLFxuICAgICAgICApfWAsXG4gICAgKTtcbiAgICByZXR1cm4gbG9jYWxlcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFN0YXRpY0RpckZvclRoZW1lKHRoZW1lOiBUaGVtZSkge1xuICAgIC8vIENhbid0IHVzZSBgdmVuZG9yYCBwcm9wIGZyb20gVGhlbWUsIGJlY2F1c2UgdGhlIGNhc2luZ1xuICAgIC8vIG1pZ2h0IGJlIGRpZmZlcmVudC4gTWFnZW50byBhbHdheXMgdXNlcyB0aGUgdGhlbWUgSUQgd2hlblxuICAgIC8vIHdyaXRpbmcgdG8gYHB1Yi9zdGF0aWNgLiBXZSBoYXZlIHRvIHNwbGl0IGhlcmUsIHRob3VnaCxcbiAgICAvLyBzbyB0aGF0ICpuaXggcGF0aCBzZXBhcmF0b3JzIGRvbid0IG1ha2UgaXQgaW4gKG5lZWQgd2luZG93cyBjb21wYXQpXG4gICAgY29uc3QgW3ZlbmRvciwgbmFtZV0gPSB0aGVtZS50aGVtZUlELnNwbGl0KCcvJyk7XG4gICAgcmV0dXJuIGpvaW4oJ3B1YicsICdzdGF0aWMnLCB0aGVtZS5hcmVhLCB2ZW5kb3IsIG5hbWUpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRUaGVtZVBhcmVudE5hbWUodGhlbWVQYXRoOiBzdHJpbmcpIHtcbiAgICB0cmFjZShgY2hlY2tpbmcgZm9yIHBhcmVudCBvZiB0aGVtZSBhdCAke3RoZW1lUGF0aH1gKTtcbiAgICBjb25zdCB0aGVtZVhNTFBhdGggPSBqb2luKHRoZW1lUGF0aCwgJ3RoZW1lLnhtbCcpO1xuICAgIGNvbnN0IHNvdXJjZSA9IGF3YWl0IHJlYWRGaWxlKHRoZW1lWE1MUGF0aCwgJ3V0ZjgnKS5jYXRjaCgoKSA9PiAnJyk7XG4gICAgaWYgKCFzb3VyY2UpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhbGVyRXJyb3IoXG4gICAgICAgICAgICBgQ291bGQgbm90IGZpbmQgdGhlbWUgY29uZmlndXJhdGlvbiAodGhlbWUueG1sKSBmb3IgdGhlbWUgYXQgXCIke3RoZW1lWE1MUGF0aH1cImAsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgcGFyc2VkVGhlbWVDb25maWcgPSBwYXJzZVhNTChzb3VyY2UsIHtcbiAgICAgICAgaWdub3JlQXR0cmlidXRlczogZmFsc2UsXG4gICAgICAgIGF0dHJpYnV0ZU5hbWVQcmVmaXg6ICcnLFxuICAgICAgICBpZ25vcmVOYW1lU3BhY2U6IHRydWUsXG4gICAgfSk7XG5cbiAgICBjb25zdCBwYXJlbnQgPSAocGFyc2VkVGhlbWVDb25maWcudGhlbWUucGFyZW50IGFzIHN0cmluZykgfHwgJyc7XG4gICAgdHJhY2UoXG4gICAgICAgIHBhcmVudFxuICAgICAgICAgICAgPyBgZm91bmQgcGFyZW50IG9mICR7cGFyZW50fSBmb3IgdGhlbWUgYXQgJHt0aGVtZVBhdGh9YFxuICAgICAgICAgICAgOiBgbm8gcGFyZW50IGZvdW5kIGZvciB0aGVtZSBhdCBwYXRoICR7dGhlbWVQYXRofWAsXG4gICAgKTtcbiAgICByZXR1cm4gcGFyZW50O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXREZXBsb3llZFRoZW1lc0ZvclZlbmRvcihcbiAgICBtYWdlbnRvUm9vdDogc3RyaW5nLFxuICAgIGFyZWE6ICdmcm9udGVuZCcgfCAnYWRtaW5odG1sJyxcbiAgICB2ZW5kb3I6IHN0cmluZyxcbik6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCB2ZW5kb3JQYXRoID0gam9pbihtYWdlbnRvUm9vdCwgJ3B1YicsICdzdGF0aWMnLCBhcmVhLCB2ZW5kb3IpO1xuICAgIGNvbnN0IHZlbmRvckVudHJpZXMgPSBhd2FpdCBnZXREaXJFbnRyaWVzQXRQYXRoKHZlbmRvclBhdGgpO1xuICAgIGNvbnN0IHRoZW1lTmFtZXMgPSB2ZW5kb3JFbnRyaWVzLmZpbHRlcihlID0+IC9eW2EtekEtWjAtOS1fXSskLy50ZXN0KGUpKTtcblxuICAgIHJldHVybiB0aGVtZU5hbWVzLm1hcChuYW1lID0+IGAke3ZlbmRvcn0vJHtuYW1lfWApO1xufVxuXG5jb25zdCBnZXREaXJFbnRyaWVzQXRQYXRoID0gKHBhdGg6IHN0cmluZykgPT5cbiAgICByZWFkZGlyKHBhdGgsIHsgd2l0aEZpbGVUeXBlczogdHJ1ZSB9KVxuICAgICAgICAudGhlbihlbnRyaWVzID0+IGVudHJpZXMuZmlsdGVyKGQgPT4gZC5pc0RpcmVjdG9yeSgpKS5tYXAoZCA9PiBkLm5hbWUpKVxuICAgICAgICAuY2F0Y2goKCkgPT4gW10gYXMgc3RyaW5nW10pO1xuIl19