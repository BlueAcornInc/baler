"use strict";
/**
 * Copyright Â© Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fsPromises_1 = require("./fsPromises");
const fs_1 = require("fs");
const path_1 = require("path");
const fast_glob_1 = __importDefault(require("fast-glob"));
// @ts-ignore
const glob_1 = __importDefault(require("glob"));
const flatten_1 = require("./flatten");
const fromentries_1 = __importDefault(require("fromentries"));
const fast_xml_parser_1 = require("fast-xml-parser");
const findUp_1 = require("./findUp");
const magentoInterop_1 = require("./magentoInterop");
const BalerError_1 = require("./BalerError");
const trace_1 = require("./trace");
const parseTemplateDeps_1 = require("./parseTemplateDeps");
/**
 * @summary Verify all the dirs we need from Magento are available.
 *          Things to be checked should be kept to the essentials
 *          (see: https://github.com/magento/baler/issues/30)
 */
async function findMagentoRoot(dir) {
    trace_1.trace(`looking for magento root starting at ${dir}`);
    const EXPECTED_ENTRIES = ['app', 'vendor', 'pub'];
    const predicate = (dir, entries) => {
        return EXPECTED_ENTRIES.every(e => entries.includes(e));
    };
    return findUp_1.findUp(dir, predicate);
}
exports.findMagentoRoot = findMagentoRoot;
/**
 * @summary Get a list of names for all enabled modules.
 *          We _could_ use a full PHP parser here to be safe,
 *          but `app/etc/config.php` is codegen'd, so the odds
 *          of it not following very specific conventions is small
 */
async function getEnabledModules(magentoRoot) {
    trace_1.trace('reading enabled modules from app/etc/config.php');
    const configPath = path_1.join(magentoRoot, 'app/etc/config.php');
    const rawConfig = await fsPromises_1.readFile(configPath, 'utf8').catch(() => '');
    if (!rawConfig) {
        throw new BalerError_1.BalerError(`Failed to read list of enabled modules from ${configPath}`);
    }
    const [, rawArrayBody = ''] = rawConfig.match(/'modules'\s*=>\s*\[(.+)\]/s) || [];
    const items = rawArrayBody.split(',').map(t => t.trim());
    const enabledModules = [];
    for (const item of items) {
        const [, name = '', enabledStr = ''] = item.match(/'(\w+)'\s*=>\s*([01])/) || [];
        if (name && Number(enabledStr))
            enabledModules.push(name);
    }
    trace_1.trace(`enabled modules: ${JSON.stringify(enabledModules)}`);
    return enabledModules;
}
exports.getEnabledModules = getEnabledModules;
async function getComponents(magentoRoot) {
    const componentPaths = await magentoInterop_1.getModulesAndThemesFromMagento(magentoRoot);
    return {
        themes: await getThemesFromPaths(componentPaths.themes),
        modules: getModulesFromPaths(componentPaths.modules),
    };
}
exports.getComponents = getComponents;
async function getThemesFromPaths(themePaths) {
    const pendingThemes = Object.entries(themePaths).map(async ([fullID, path]) => {
        const [area, vendor, name] = fullID.split('/');
        const themeID = `${vendor}/${name}`;
        const theme = {
            name,
            vendor,
            area: area,
            themeID,
            path,
            parentID: await getThemeParentName(path),
        };
        return [themeID, theme];
    });
    return fromentries_1.default(await Promise.all(pendingThemes));
}
function getModulesFromPaths(modulePaths) {
    return fromentries_1.default(Object.entries(modulePaths).map(([moduleID, path]) => {
        const mod = {
            moduleID,
            path: path,
        };
        return [moduleID, mod];
    }));
}
/**
 * @summary Get a list of all _deployed_ frontend and adminhtml themes
 *          for all vendors
 */
async function getDeployedThemes(magentoRoot) {
    trace_1.trace('checking pub/static for deployed themes');
    const staticRoot = path_1.join(magentoRoot, 'pub', 'static');
    const [frontendVendors, adminVendors] = await Promise.all([
        getDirEntriesAtPath(path_1.join(staticRoot, 'frontend')),
        getDirEntriesAtPath(path_1.join(staticRoot, 'adminhtml')),
    ]);
    const pendingFrontendThemes = Promise.all(frontendVendors.map(v => getDeployedThemesForVendor(magentoRoot, 'frontend', v)));
    const pendingAdminThemes = Promise.all(adminVendors.map(v => getDeployedThemesForVendor(magentoRoot, 'adminhtml', v)));
    const [frontendThemes, adminThemes] = await Promise.all([
        pendingFrontendThemes,
        pendingAdminThemes,
    ]);
    const deployedThemes = [
        ...flatten_1.flatten(frontendThemes),
        ...flatten_1.flatten(adminThemes),
    ];
    trace_1.trace(`found deployed themes: ${deployedThemes}`);
    return deployedThemes;
}
exports.getDeployedThemes = getDeployedThemes;
/**
 * @summary Get an unordered list of all .phtml files for a specific
 *          area (frontend/adminhtml/base) for enabled modules only
 * @todo Switch from fast-glob to manual recursive crawling of the fs.
 *       Globbing has too much of a perf penalty
 */
async function getPHTMLFilesEligibleForUseWithTheme(themeHierarchy, enabledModules, modules) {
    const moduleGlobs = enabledModules.map(moduleID => {
        const mod = modules[moduleID];
        return path_1.join(mod.path, 'view', `{${themeHierarchy[0].area},base}`, 'templates', '**/*.phtml');
    });
    const themeGlobs = flatten_1.flatten(enabledModules.map(m => {
        return themeHierarchy.map(t => `${t.path}/${m}/templates/**/*.phtml`);
    }));
    return fast_glob_1.default([...moduleGlobs, ...themeGlobs], {
        onlyFiles: true,
    });
}
exports.getPHTMLFilesEligibleForUseWithTheme = getPHTMLFilesEligibleForUseWithTheme;
async function getLayoutFilesEligibleForUseWithTheme(themeHierarchy, enabledModules, modules) {
    const promises = [];
    const globbyCallback = (resolve, reject) => (err, files) => {
        if (err) {
            reject(err);
        }
        else {
            resolve(files);
        }
    };
    for (const enabledModule of enabledModules) {
        const mod = modules[enabledModule];
        if (mod) {
            promises.push(new Promise((resolve, reject) => {
                glob_1.default(path_1.join(mod.path, 'view', themeHierarchy[0].area, 'layout', '*.xml'), globbyCallback(resolve, reject));
            }));
            promises.push(new Promise((resolve, reject) => {
                glob_1.default(path_1.join(mod.path, 'view', 'base', 'layout', '*.xml'), globbyCallback(resolve, reject));
            }));
            for (const theme of themeHierarchy) {
                promises.push(new Promise((resolve, reject) => {
                    glob_1.default(path_1.join(theme.path, enabledModule, 'layout', '*.xml'), globbyCallback(resolve, reject));
                }));
            }
        }
    }
    const filePaths = await Promise.all(promises);
    let allPaths = [];
    for (const filePathsArray of filePaths) {
        // @ts-ignore
        allPaths = allPaths.concat(filePathsArray);
    }
    console.log(allPaths);
    return allPaths;
}
exports.getLayoutFilesEligibleForUseWithTheme = getLayoutFilesEligibleForUseWithTheme;
;
async function getPHTMLFilesFromLayoutHandle(layoutFile, themeHierarchy, modules) {
    const templates = [];
    // Read layout file
    const layoutXml = await fsPromises_1.readFile(layoutFile, 'utf8').catch(() => '');
    // Get phtml files
    let matches = layoutXml.match(/template="(.*?)"/g);
    if (matches) {
        const matchesArray = matches.map(match => match.match(/"(.*?)"/));
        for (const match of matchesArray) {
            if (match instanceof Array) {
                templates.push(match[1]);
            }
        }
    }
    // Convert phtml files into file paths
    return templates
        // Fully qualified only
        .filter(template => template.split('::').length > 1)
        // Resolve path
        .map(template => {
        const [moduleName, file] = template.split('::');
        const fallbackPaths = themeHierarchy
            .map(theme => `${theme.path}/${moduleName}/templates/${file}`);
        fallbackPaths.push(`${modules[moduleName].path}/view/${themeHierarchy[0].area}/templates/${file}`);
        fallbackPaths.push(`${modules[moduleName].path}/view/base/templates/${file}`);
        for (const fallback of fallbackPaths) {
            try {
                const found = fs_1.statSync(fallback);
                return fallback;
            }
            catch (err) { }
        }
        return '';
    })
        // Remove templates that we couldn't find
        .filter((template) => template.length > 0);
}
exports.getPHTMLFilesFromLayoutHandle = getPHTMLFilesFromLayoutHandle;
;
async function getDepsFromPHTMLPath(templateFile) {
    const templateContent = await fsPromises_1.readFile(templateFile, 'utf8').catch(() => '');
    const { deps } = parseTemplateDeps_1.parseTemplateDeps(templateContent);
    return deps || [];
}
exports.getDepsFromPHTMLPath = getDepsFromPHTMLPath;
async function getLocalesForDeployedTheme(magentoRoot, theme) {
    trace_1.trace(`fetching deployed locales for ${theme.themeID}`);
    const themeRoot = path_1.join(magentoRoot, getStaticDirForTheme(theme));
    const dirs = await getDirEntriesAtPath(themeRoot);
    // filter out any extra files/folders that aren't locales
    const reLang = /^[a-z]{2}(?:_[a-z]{2})?$/i;
    const locales = dirs.filter(d => reLang.test(d));
    trace_1.trace(`found deployed locales for ${theme.themeID}: ${JSON.stringify(locales)}`);
    return locales;
}
exports.getLocalesForDeployedTheme = getLocalesForDeployedTheme;
function getStaticDirForTheme(theme) {
    // Can't use `vendor` prop from Theme, because the casing
    // might be different. Magento always uses the theme ID when
    // writing to `pub/static`. We have to split here, though,
    // so that *nix path separators don't make it in (need windows compat)
    const [vendor, name] = theme.themeID.split('/');
    return path_1.join('pub', 'static', theme.area, vendor, name);
}
exports.getStaticDirForTheme = getStaticDirForTheme;
async function getThemeParentName(themePath) {
    trace_1.trace(`checking for parent of theme at ${themePath}`);
    const themeXMLPath = path_1.join(themePath, 'theme.xml');
    const source = await fsPromises_1.readFile(themeXMLPath, 'utf8').catch(() => '');
    if (!source) {
        throw new BalerError_1.BalerError(`Could not find theme configuration (theme.xml) for theme at "${themeXMLPath}"`);
    }
    const parsedThemeConfig = fast_xml_parser_1.parse(source, {
        ignoreAttributes: false,
        attributeNamePrefix: '',
        ignoreNameSpace: true,
    });
    const parent = parsedThemeConfig.theme.parent || '';
    trace_1.trace(parent
        ? `found parent of ${parent} for theme at ${themePath}`
        : `no parent found for theme at path ${themePath}`);
    return parent;
}
async function getDeployedThemesForVendor(magentoRoot, area, vendor) {
    const vendorPath = path_1.join(magentoRoot, 'pub', 'static', area, vendor);
    const vendorEntries = await getDirEntriesAtPath(vendorPath);
    const themeNames = vendorEntries.filter(e => /^[a-zA-Z0-9-_]+$/.test(e));
    return themeNames.map(name => `${vendor}/${name}`);
}
const getDirEntriesAtPath = (path) => fsPromises_1.readdir(path, { withFileTypes: true })
    .then(entries => entries.filter(d => d.isDirectory()).map(d => d.name))
    .catch(() => []);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFnZW50b0ZTLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL21hZ2VudG9GUy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7OztBQUVILDZDQUFpRDtBQUNqRCwyQkFBOEI7QUFDOUIsK0JBQTRCO0FBQzVCLDBEQUE2QjtBQUM3QixhQUFhO0FBQ2IsZ0RBQTBDO0FBQzFDLHVDQUFvQztBQUVwQyw4REFBc0M7QUFDdEMscURBQW9EO0FBQ3BELHFDQUFrQztBQUNsQyxxREFBa0U7QUFDbEUsNkNBQTBDO0FBQzFDLG1DQUFnQztBQUNoQywyREFBd0Q7QUFFeEQ7Ozs7R0FJRztBQUNJLEtBQUssVUFBVSxlQUFlLENBQUMsR0FBVztJQUM3QyxhQUFLLENBQUMsd0NBQXdDLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDckQsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDbEQsTUFBTSxTQUFTLEdBQUcsQ0FBQyxHQUFXLEVBQUUsT0FBaUIsRUFBRSxFQUFFO1FBQ2pELE9BQU8sZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzVELENBQUMsQ0FBQztJQUVGLE9BQU8sZUFBTSxDQUFDLEdBQUcsRUFBRSxTQUFTLENBQUMsQ0FBQztBQUNsQyxDQUFDO0FBUkQsMENBUUM7QUFFRDs7Ozs7R0FLRztBQUNJLEtBQUssVUFBVSxpQkFBaUIsQ0FBQyxXQUFtQjtJQUN2RCxhQUFLLENBQUMsaURBQWlELENBQUMsQ0FBQztJQUN6RCxNQUFNLFVBQVUsR0FBRyxXQUFJLENBQUMsV0FBVyxFQUFFLG9CQUFvQixDQUFDLENBQUM7SUFDM0QsTUFBTSxTQUFTLEdBQUcsTUFBTSxxQkFBUSxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFF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LENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFekUsT0FBTyxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQztBQUN2RCxDQUFDO0FBRUQsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLElBQVksRUFBRSxFQUFFLENBQ3pDLG9CQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDO0tBQ2pDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDdEUsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQWMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgwqkgTWFnZW50bywgSW5jLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogU2VlIENPUFlJTkcudHh0IGZvciBsaWNlbnNlIGRldGFpbHMuXG4gKi9cblxuaW1wb3J0IHsgcmVhZEZpbGUsIHJlYWRkaXIgfSBmcm9tICcuL2ZzUHJvbWlzZXMnO1xuaW1wb3J0IHsgc3RhdFN5bmMgfSBmcm9tICdmcyc7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgZ2xvYiBmcm9tICdmYXN0LWdsb2InO1xuLy8gQHRzLWlnbm9yZVxuaW1wb3J0IGdsb2JUaGF0V29ya3NXaXRoQ2xvdWQgZnJvbSAnZ2xvYic7XG5pbXBvcnQgeyBmbGF0dGVuIH0gZnJvbSAnLi9mbGF0dGVuJztcbmltcG9ydCB7IFRoZW1lLCBDb21wb25lbnRzLCBNb2R1bGUsIENvbXBvbmVudFBhdGhzIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgZnJvbUVudHJpZXMgZnJvbSAnZnJvbWVudHJpZXMnO1xuaW1wb3J0IHsgcGFyc2UgYXMgcGFyc2VYTUwgfSBmcm9tICdmYXN0LXhtbC1wYXJzZXInO1xuaW1wb3J0IHsgZmluZFVwIH0gZnJvbSAnLi9maW5kVXAnO1xuaW1wb3J0IHsgZ2V0TW9kdWxlc0FuZFRoZW1lc0Zyb21NYWdlbnRvIH0gZnJvbSAnLi9tYWdlbnRvSW50ZXJvcCc7XG5pbXBvcnQgeyBCYWxlckVycm9yIH0gZnJvbSAnLi9CYWxlckVycm9yJztcbmltcG9ydCB7IHRyYWNlIH0gZnJvbSAnLi90cmFjZSc7XG5pbXBvcnQgeyBwYXJzZVRlbXBsYXRlRGVwcyB9IGZyb20gJy4vcGFyc2VUZW1wbGF0ZURlcHMnO1xuXG4vKipcbiAqIEBzdW1tYXJ5IFZlcmlmeSBhbGwgdGhlIGRpcnMgd2UgbmVlZCBmcm9tIE1hZ2VudG8gYXJlIGF2YWlsYWJsZS5cbiAqICAgICAgICAgIFRoaW5ncyB0byBiZSBjaGVja2VkIHNob3VsZCBiZSBrZXB0IHRvIHRoZSBlc3NlbnRpYWxzXG4gKiAgICAgICAgICAoc2VlOiBodHRwczovL2dpdGh1Yi5jb20vbWFnZW50by9iYWxlci9pc3N1ZXMvMzApXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBmaW5kTWFnZW50b1Jvb3QoZGlyOiBzdHJpbmcpIHtcbiAgICB0cmFjZShgbG9va2luZyBmb3IgbWFnZW50byByb290IHN0YXJ0aW5nIGF0ICR7ZGlyfWApO1xuICAgIGNvbnN0IEVYUEVDVEVEX0VOVFJJRVMgPSBbJ2FwcCcsICd2ZW5kb3InLCAncHViJ107XG4gICAgY29uc3QgcHJlZGljYXRlID0gKGRpcjogc3RyaW5nLCBlbnRyaWVzOiBzdHJpbmdbXSkgPT4ge1xuICAgICAgICByZXR1cm4gRVhQRUNURURfRU5UUklFUy5ldmVyeShlID0+IGVudHJpZXMuaW5jbHVkZXMoZSkpO1xuICAgIH07XG5cbiAgICByZXR1cm4gZmluZFVwKGRpciwgcHJlZGljYXRlKTtcbn1cblxuLyoqXG4gKiBAc3VtbWFyeSBHZXQgYSBsaXN0IG9mIG5hbWVzIGZvciBhbGwgZW5hYmxlZCBtb2R1bGVzLlxuICogICAgICAgICAgV2UgX2NvdWxkXyB1c2UgYSBmdWxsIFBIUCBwYXJzZXIgaGVyZSB0byBiZSBzYWZlLFxuICogICAgICAgICAgYnV0IGBhcHAvZXRjL2NvbmZpZy5waHBgIGlzIGNvZGVnZW4nZCwgc28gdGhlIG9kZHNcbiAqICAgICAgICAgIG9mIGl0IG5vdCBmb2xsb3dpbmcgdmVyeSBzcGVjaWZpYyBjb252ZW50aW9ucyBpcyBzbWFsbFxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RW5hYmxlZE1vZHVsZXMobWFnZW50b1Jvb3Q6IHN0cmluZykge1xuICAgIHRyYWNlKCdyZWFkaW5nIGVuYWJsZWQgbW9kdWxlcyBmcm9tIGFwcC9ldGMvY29uZmlnLnBocCcpO1xuICAgIGNvbnN0IGNvbmZpZ1BhdGggPSBqb2luKG1hZ2VudG9Sb290LCAnYXBwL2V0Yy9jb25maWcucGhwJyk7XG4gICAgY29uc3QgcmF3Q29uZmlnID0gYXdhaXQgcmVhZEZpbGUoY29uZmlnUGF0aCwgJ3V0ZjgnKS5jYXRjaCgoKSA9PiAnJyk7XG4gICAgaWYgKCFyYXdDb25maWcpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhbGVyRXJyb3IoXG4gICAgICAgICAgICBgRmFpbGVkIHRvIHJlYWQgbGlzdCBvZiBlbmFibGVkIG1vZHVsZXMgZnJvbSAke2NvbmZpZ1BhdGh9YCxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBbLCByYXdBcnJheUJvZHkgPSAnJ10gPVxuICAgICAgICByYXdDb25maWcubWF0Y2goLydtb2R1bGVzJ1xccyo9PlxccypcXFsoLispXFxdL3MpIHx8IFtdO1xuICAgIGNvbnN0IGl0ZW1zID0gcmF3QXJyYXlCb2R5LnNwbGl0KCcsJykubWFwKHQgPT4gdC50cmltKCkpO1xuXG4gICAgY29uc3QgZW5hYmxlZE1vZHVsZXM6IHN0cmluZ1tdID0gW107XG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zKSB7XG4gICAgICAgIGNvbnN0IFssIG5hbWUgPSAnJywgZW5hYmxlZFN0ciA9ICcnXSA9XG4gICAgICAgICAgICBpdGVtLm1hdGNoKC8nKFxcdyspJ1xccyo9PlxccyooWzAxXSkvKSB8fCBbXTtcbiAgICAgICAgaWYgKG5hbWUgJiYgTnVtYmVyKGVuYWJsZWRTdHIpKSBlbmFibGVkTW9kdWxlcy5wdXNoKG5hbWUpO1xuICAgIH1cblxuICAgIHRyYWNlKGBlbmFibGVkIG1vZHVsZXM6ICR7SlNPTi5zdHJpbmdpZnkoZW5hYmxlZE1vZHVsZXMpfWApO1xuICAgIHJldHVybiBlbmFibGVkTW9kdWxlcztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldENvbXBvbmVudHMobWFnZW50b1Jvb3Q6IHN0cmluZyk6IFByb21pc2U8Q29tcG9uZW50cz4ge1xuICAgIGNvbnN0IGNvbXBvbmVudFBhdGhzID0gYXdhaXQgZ2V0TW9kdWxlc0FuZFRoZW1lc0Zyb21NYWdlbnRvKG1hZ2VudG9Sb290KTtcbiAgICByZXR1cm4ge1xuICAgICAgICB0aGVtZXM6IGF3YWl0IGdldFRoZW1lc0Zyb21QYXRocyhjb21wb25lbnRQYXRocy50aGVtZXMpLFxuICAgICAgICBtb2R1bGVzOiBnZXRNb2R1bGVzRnJvbVBhdGhzKGNvbXBvbmVudFBhdGhzLm1vZHVsZXMpLFxuICAgIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFRoZW1lc0Zyb21QYXRocyhcbiAgICB0aGVtZVBhdGhzOiBDb21wb25lbnRQYXRoc1sndGhlbWVzJ10sXG4pOiBQcm9taXNlPFJlY29yZDxzdHJpbmcsIFRoZW1lPj4ge1xuICAgIGNvbnN0IHBlbmRpbmdUaGVtZXM6IFByb21pc2U8W3N0cmluZywgVGhlbWVdPltdID0gT2JqZWN0LmVudHJpZXMoXG4gICAgICAgIHRoZW1lUGF0aHMsXG4gICAgKS5tYXAoYXN5bmMgKFtmdWxsSUQsIHBhdGhdKSA9PiB7XG4gICAgICAgIGNvbnN0IFthcmVhLCB2ZW5kb3IsIG5hbWVdID0gZnVsbElELnNwbGl0KCcvJyk7XG4gICAgICAgIGNvbnN0IHRoZW1lSUQgPSBgJHt2ZW5kb3J9LyR7bmFtZX1gO1xuICAgICAgICBjb25zdCB0aGVtZTogVGhlbWUgPSB7XG4gICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgdmVuZG9yLFxuICAgICAgICAgICAgYXJlYTogYXJlYSBhcyBUaGVtZVsnYXJlYSddLFxuICAgICAgICAgICAgdGhlbWVJRCxcbiAgICAgICAgICAgIHBhdGgsXG4gICAgICAgICAgICBwYXJlbnRJRDogYXdhaXQgZ2V0VGhlbWVQYXJlbnROYW1lKHBhdGgpLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gW3RoZW1lSUQsIHRoZW1lXSBhcyBbc3RyaW5nLCBUaGVtZV07XG4gICAgfSk7XG4gICAgcmV0dXJuIGZyb21FbnRyaWVzKGF3YWl0IFByb21pc2UuYWxsKHBlbmRpbmdUaGVtZXMpKTtcbn1cblxuZnVuY3Rpb24gZ2V0TW9kdWxlc0Zyb21QYXRocyhcbiAgICBtb2R1bGVQYXRoczogQ29tcG9uZW50UGF0aHNbJ21vZHVsZXMnXSxcbik6IFJlY29yZDxzdHJpbmcsIE1vZHVsZT4ge1xuICAgIHJldHVybiBmcm9tRW50cmllcyhcbiAgICAgICAgT2JqZWN0LmVudHJpZXMobW9kdWxlUGF0aHMpLm1hcCgoW21vZHVsZUlELCBwYXRoXSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbW9kOiBNb2R1bGUgPSB7XG4gICAgICAgICAgICAgICAgbW9kdWxlSUQsXG4gICAgICAgICAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXR1cm4gW21vZHVsZUlELCBtb2RdIGFzIFtzdHJpbmcsIE1vZHVsZV07XG4gICAgICAgIH0pLFxuICAgICk7XG59XG5cbi8qKlxuICogQHN1bW1hcnkgR2V0IGEgbGlzdCBvZiBhbGwgX2RlcGxveWVkXyBmcm9udGVuZCBhbmQgYWRtaW5odG1sIHRoZW1lc1xuICogICAgICAgICAgZm9yIGFsbCB2ZW5kb3JzXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXREZXBsb3llZFRoZW1lcyhcbiAgICBtYWdlbnRvUm9vdDogc3RyaW5nLFxuKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIHRyYWNlKCdjaGVja2luZyBwdWIvc3RhdGljIGZvciBkZXBsb3llZCB0aGVtZXMnKTtcbiAgICBjb25zdCBzdGF0aWNSb290ID0gam9pbihtYWdlbnRvUm9vdCwgJ3B1YicsICdzdGF0aWMnKTtcblxuICAgIGNvbnN0IFtmcm9udGVuZFZlbmRvcnMsIGFkbWluVmVuZG9yc10gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIGdldERpckVudHJpZXNBdFBhdGgoam9pbihzdGF0aWNSb290LCAnZnJvbnRlbmQnKSksXG4gICAgICAgIGdldERpckVudHJpZXNBdFBhdGgoam9pbihzdGF0aWNSb290LCAnYWRtaW5odG1sJykpLFxuICAgIF0pO1xuXG4gICAgY29uc3QgcGVuZGluZ0Zyb250ZW5kVGhlbWVzID0gUHJvbWlzZS5hbGwoXG4gICAgICAgIGZyb250ZW5kVmVuZG9ycy5tYXAodiA9PlxuICAgICAgICAgICAgZ2V0RGVwbG95ZWRUaGVtZXNGb3JWZW5kb3IobWFnZW50b1Jvb3QsICdmcm9udGVuZCcsIHYpLFxuICAgICAgICApLFxuICAgICk7XG4gICAgY29uc3QgcGVuZGluZ0FkbWluVGhlbWVzID0gUHJvbWlzZS5hbGwoXG4gICAgICAgIGFkbWluVmVuZG9ycy5tYXAodiA9PlxuICAgICAgICAgICAgZ2V0RGVwbG95ZWRUaGVtZXNGb3JWZW5kb3IobWFnZW50b1Jvb3QsICdhZG1pbmh0bWwnLCB2KSxcbiAgICAgICAgKSxcbiAgICApO1xuXG4gICAgY29uc3QgW2Zyb250ZW5kVGhlbWVzLCBhZG1pblRoZW1lc10gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIHBlbmRpbmdGcm9udGVuZFRoZW1lcyxcbiAgICAgICAgcGVuZGluZ0FkbWluVGhlbWVzLFxuICAgIF0pO1xuXG4gICAgY29uc3QgZGVwbG95ZWRUaGVtZXMgPSBbXG4gICAgICAgIC4uLmZsYXR0ZW4oZnJvbnRlbmRUaGVtZXMpLFxuICAgICAgICAuLi5mbGF0dGVuKGFkbWluVGhlbWVzKSxcbiAgICBdO1xuICAgIHRyYWNlKGBmb3VuZCBkZXBsb3llZCB0aGVtZXM6ICR7ZGVwbG95ZWRUaGVtZXN9YCk7XG4gICAgcmV0dXJuIGRlcGxveWVkVGhlbWVzO1xufVxuXG4vKipcbiAqIEBzdW1tYXJ5IEdldCBhbiB1bm9yZGVyZWQgbGlzdCBvZiBhbGwgLnBodG1sIGZpbGVzIGZvciBhIHNwZWNpZmljXG4gKiAgICAgICAgICBhcmVhIChmcm9udGVuZC9hZG1pbmh0bWwvYmFzZSkgZm9yIGVuYWJsZWQgbW9kdWxlcyBvbmx5XG4gKiBAdG9kbyBTd2l0Y2ggZnJvbSBmYXN0LWdsb2IgdG8gbWFudWFsIHJlY3Vyc2l2ZSBjcmF3bGluZyBvZiB0aGUgZnMuXG4gKiAgICAgICBHbG9iYmluZyBoYXMgdG9vIG11Y2ggb2YgYSBwZXJmIHBlbmFsdHlcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFBIVE1MRmlsZXNFbGlnaWJsZUZvclVzZVdpdGhUaGVtZShcbiAgICB0aGVtZUhpZXJhcmNoeTogVGhlbWVbXSxcbiAgICBlbmFibGVkTW9kdWxlczogc3RyaW5nW10sXG4gICAgbW9kdWxlczogUmVjb3JkPHN0cmluZywgTW9kdWxlPixcbik6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCBtb2R1bGVHbG9icyA9IGVuYWJsZWRNb2R1bGVzLm1hcChtb2R1bGVJRCA9PiB7XG4gICAgICAgIGNvbnN0IG1vZCA9IG1vZHVsZXNbbW9kdWxlSURdO1xuICAgICAgICByZXR1cm4gam9pbihcbiAgICAgICAgICAgIG1vZC5wYXRoLFxuICAgICAgICAgICAgJ3ZpZXcnLFxuICAgICAgICAgICAgYHske3RoZW1lSGllcmFyY2h5WzBdLmFyZWF9LGJhc2V9YCxcbiAgICAgICAgICAgICd0ZW1wbGF0ZXMnLFxuICAgICAgICAgICAgJyoqLyoucGh0bWwnLFxuICAgICAgICApO1xuICAgIH0pO1xuXG4gICAgY29uc3QgdGhlbWVHbG9icyA9IGZsYXR0ZW4oXG4gICAgICAgIGVuYWJsZWRNb2R1bGVzLm1hcChtID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGVtZUhpZXJhcmNoeS5tYXAoXG4gICAgICAgICAgICAgICAgdCA9PiBgJHt0LnBhdGh9LyR7bX0vdGVtcGxhdGVzLyoqLyoucGh0bWxgLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSksXG4gICAgKTtcblxuICAgIHJldHVybiBnbG9iKFsuLi5tb2R1bGVHbG9icywgLi4udGhlbWVHbG9ic10sIHtcbiAgICAgICAgb25seUZpbGVzOiB0cnVlLFxuICAgIH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0TGF5b3V0RmlsZXNFbGlnaWJsZUZvclVzZVdpdGhUaGVtZShcbiAgICB0aGVtZUhpZXJhcmNoeTogVGhlbWVbXSxcbiAgICBlbmFibGVkTW9kdWxlczogc3RyaW5nW10sXG4gICAgbW9kdWxlczogUmVjb3JkPHN0cmluZywgTW9kdWxlPixcbikge1xuICAgIGNvbnN0IHByb21pc2VzID0gW107XG5cbiAgICBjb25zdCBnbG9iYnlDYWxsYmFjayA9IChyZXNvbHZlOiBGdW5jdGlvbiwgcmVqZWN0OiBGdW5jdGlvbikgPT4gKGVycjogc3RyaW5nLCBmaWxlczogc3RyaW5nW10pID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXNvbHZlKGZpbGVzKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBmb3IgKGNvbnN0IGVuYWJsZWRNb2R1bGUgb2YgZW5hYmxlZE1vZHVsZXMpIHtcbiAgICAgICAgY29uc3QgbW9kID0gbW9kdWxlc1tlbmFibGVkTW9kdWxlXTtcbiAgICAgICAgaWYgKG1vZCkge1xuICAgICAgICAgICAgcHJvbWlzZXMucHVzaChcbiAgICAgICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGdsb2JUaGF0V29ya3NXaXRoQ2xvdWQoXG4gICAgICAgICAgICAgICAgICAgICAgICBqb2luKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZC5wYXRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd2aWV3JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVtZUhpZXJhcmNoeVswXS5hcmVhLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYXlvdXQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICcqLnhtbCdcbiAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICBnbG9iYnlDYWxsYmFjayhyZXNvbHZlLCByZWplY3QpXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgcHJvbWlzZXMucHVzaChcbiAgICAgICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGdsb2JUaGF0V29ya3NXaXRoQ2xvdWQoXG4gICAgICAgICAgICAgICAgICAgICAgICBqb2luKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZC5wYXRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd2aWV3JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYmFzZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xheW91dCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJyoueG1sJ1xuICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JieUNhbGxiYWNrKHJlc29sdmUsIHJlamVjdClcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgdGhlbWUgb2YgdGhlbWVIaWVyYXJjaHkpIHtcbiAgICAgICAgICAgICAgICBwcm9taXNlcy5wdXNoKFxuICAgICAgICAgICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBnbG9iVGhhdFdvcmtzV2l0aENsb3VkKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpvaW4oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZW1lLnBhdGgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuYWJsZWRNb2R1bGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYXlvdXQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnKi54bWwnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnbG9iYnlDYWxsYmFjayhyZXNvbHZlLCByZWplY3QpXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGZpbGVQYXRocyA9IGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgICBsZXQgYWxsUGF0aHM6IHN0cmluZ1tdID0gW107XG5cbiAgICBmb3IgKGNvbnN0IGZpbGVQYXRoc0FycmF5IG9mIGZpbGVQYXRocykge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGFsbFBhdGhzID0gYWxsUGF0aHMuY29uY2F0KGZpbGVQYXRoc0FycmF5KTtcbiAgICB9XG4gICAgY29uc29sZS5sb2coYWxsUGF0aHMpO1xuXG4gICAgcmV0dXJuIGFsbFBhdGhzO1xufTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFBIVE1MRmlsZXNGcm9tTGF5b3V0SGFuZGxlKFxuICAgIGxheW91dEZpbGU6IHN0cmluZyxcbiAgICB0aGVtZUhpZXJhcmNoeTogVGhlbWVbXSxcbiAgICBtb2R1bGVzOiBSZWNvcmQ8c3RyaW5nLCBNb2R1bGU+XG4pOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgdGVtcGxhdGVzID0gW107XG4gICAgLy8gUmVhZCBsYXlvdXQgZmlsZVxuICAgIGNvbnN0IGxheW91dFhtbCA9IGF3YWl0IHJlYWRGaWxlKGxheW91dEZpbGUsICd1dGY4JykuY2F0Y2goKCkgPT4gJycpO1xuICAgIC8vIEdldCBwaHRtbCBmaWxlc1xuICAgIGxldCBtYXRjaGVzID0gbGF5b3V0WG1sLm1hdGNoKC90ZW1wbGF0ZT1cIiguKj8pXCIvZyk7XG4gICAgaWYgKG1hdGNoZXMpIHtcbiAgICAgICAgY29uc3QgbWF0Y2hlc0FycmF5ID0gbWF0Y2hlcy5tYXAobWF0Y2ggPT4gbWF0Y2gubWF0Y2goL1wiKC4qPylcIi8pKTtcbiAgICAgICAgZm9yIChjb25zdCBtYXRjaCBvZiBtYXRjaGVzQXJyYXkpIHtcbiAgICAgICAgICAgIGlmIChtYXRjaCBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgICAgICAgdGVtcGxhdGVzLnB1c2gobWF0Y2hbMV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIC8vIENvbnZlcnQgcGh0bWwgZmlsZXMgaW50byBmaWxlIHBhdGhzXG4gICAgcmV0dXJuIHRlbXBsYXRlc1xuICAgICAgICAvLyBGdWxseSBxdWFsaWZpZWQgb25seVxuICAgICAgICAuZmlsdGVyKHRlbXBsYXRlID0+IHRlbXBsYXRlLnNwbGl0KCc6OicpLmxlbmd0aCA+IDEpXG4gICAgICAgIC8vIFJlc29sdmUgcGF0aFxuICAgICAgICAubWFwKHRlbXBsYXRlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IFttb2R1bGVOYW1lLCBmaWxlXSA9IHRlbXBsYXRlLnNwbGl0KCc6OicpO1xuICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tQYXRocyA9IHRoZW1lSGllcmFyY2h5XG4gICAgICAgICAgICAgICAgLm1hcCh0aGVtZSA9PiBgJHt0aGVtZS5wYXRofS8ke21vZHVsZU5hbWV9L3RlbXBsYXRlcy8ke2ZpbGV9YCk7XG4gICAgICAgICAgICBmYWxsYmFja1BhdGhzLnB1c2goYCR7bW9kdWxlc1ttb2R1bGVOYW1lXS5wYXRofS92aWV3LyR7dGhlbWVIaWVyYXJjaHlbMF0uYXJlYX0vdGVtcGxhdGVzLyR7ZmlsZX1gKTtcbiAgICAgICAgICAgIGZhbGxiYWNrUGF0aHMucHVzaChgJHttb2R1bGVzW21vZHVsZU5hbWVdLnBhdGh9L3ZpZXcvYmFzZS90ZW1wbGF0ZXMvJHtmaWxlfWApO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGZhbGxiYWNrIG9mIGZhbGxiYWNrUGF0aHMpIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBmb3VuZCA9IHN0YXRTeW5jKGZhbGxiYWNrKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge31cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuICcnXG4gICAgICAgIH0pXG4gICAgICAgIC8vIFJlbW92ZSB0ZW1wbGF0ZXMgdGhhdCB3ZSBjb3VsZG4ndCBmaW5kXG4gICAgICAgIC5maWx0ZXIoKHRlbXBsYXRlKSA9PiB0ZW1wbGF0ZS5sZW5ndGggPiAwKTtcbn07XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXREZXBzRnJvbVBIVE1MUGF0aChcbiAgICB0ZW1wbGF0ZUZpbGU6IHN0cmluZ1xuKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IHRlbXBsYXRlQ29udGVudCA9IGF3YWl0IHJlYWRGaWxlKHRlbXBsYXRlRmlsZSwgJ3V0ZjgnKS5jYXRjaCgoKSA9PiAnJyk7XG4gICAgY29uc3QgeyBkZXBzIH0gPSBwYXJzZVRlbXBsYXRlRGVwcyh0ZW1wbGF0ZUNvbnRlbnQpO1xuXG4gICAgcmV0dXJuIGRlcHMgfHwgW107XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRMb2NhbGVzRm9yRGVwbG95ZWRUaGVtZShcbiAgICBtYWdlbnRvUm9vdDogc3RyaW5nLFxuICAgIHRoZW1lOiBUaGVtZSxcbik6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICB0cmFjZShgZmV0Y2hpbmcgZGVwbG95ZWQgbG9jYWxlcyBmb3IgJHt0aGVtZS50aGVtZUlEfWApO1xuICAgIGNvbnN0IHRoZW1lUm9vdCA9IGpvaW4obWFnZW50b1Jvb3QsIGdldFN0YXRpY0RpckZvclRoZW1lKHRoZW1lKSk7XG4gICAgY29uc3QgZGlycyA9IGF3YWl0IGdldERpckVudHJpZXNBdFBhdGgodGhlbWVSb290KTtcblxuICAgIC8vIGZpbHRlciBvdXQgYW55IGV4dHJhIGZpbGVzL2ZvbGRlcnMgdGhhdCBhcmVuJ3QgbG9jYWxlc1xuICAgIGNvbnN0IHJlTGFuZyA9IC9eW2Etel17Mn0oPzpfW2Etel17Mn0pPyQvaTtcbiAgICBjb25zdCBsb2NhbGVzID0gZGlycy5maWx0ZXIoZCA9PiByZUxhbmcudGVzdChkKSk7XG4gICAgdHJhY2UoXG4gICAgICAgIGBmb3VuZCBkZXBsb3llZCBsb2NhbGVzIGZvciAke3RoZW1lLnRoZW1lSUR9OiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICAgICAgbG9jYWxlcyxcbiAgICAgICAgKX1gLFxuICAgICk7XG4gICAgcmV0dXJuIGxvY2FsZXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTdGF0aWNEaXJGb3JUaGVtZSh0aGVtZTogVGhlbWUpIHtcbiAgICAvLyBDYW4ndCB1c2UgYHZlbmRvcmAgcHJvcCBmcm9tIFRoZW1lLCBiZWNhdXNlIHRoZSBjYXNpbmdcbiAgICAvLyBtaWdodCBiZSBkaWZmZXJlbnQuIE1hZ2VudG8gYWx3YXlzIHVzZXMgdGhlIHRoZW1lIElEIHdoZW5cbiAgICAvLyB3cml0aW5nIHRvIGBwdWIvc3RhdGljYC4gV2UgaGF2ZSB0byBzcGxpdCBoZXJlLCB0aG91Z2gsXG4gICAgLy8gc28gdGhhdCAqbml4IHBhdGggc2VwYXJhdG9ycyBkb24ndCBtYWtlIGl0IGluIChuZWVkIHdpbmRvd3MgY29tcGF0KVxuICAgIGNvbnN0IFt2ZW5kb3IsIG5hbWVdID0gdGhlbWUudGhlbWVJRC5zcGxpdCgnLycpO1xuICAgIHJldHVybiBqb2luKCdwdWInLCAnc3RhdGljJywgdGhlbWUuYXJlYSwgdmVuZG9yLCBuYW1lKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0VGhlbWVQYXJlbnROYW1lKHRoZW1lUGF0aDogc3RyaW5nKSB7XG4gICAgdHJhY2UoYGNoZWNraW5nIGZvciBwYXJlbnQgb2YgdGhlbWUgYXQgJHt0aGVtZVBhdGh9YCk7XG4gICAgY29uc3QgdGhlbWVYTUxQYXRoID0gam9pbih0aGVtZVBhdGgsICd0aGVtZS54bWwnKTtcbiAgICBjb25zdCBzb3VyY2UgPSBhd2FpdCByZWFkRmlsZSh0aGVtZVhNTFBhdGgsICd1dGY4JykuY2F0Y2goKCkgPT4gJycpO1xuICAgIGlmICghc291cmNlKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWxlckVycm9yKFxuICAgICAgICAgICAgYENvdWxkIG5vdCBmaW5kIHRoZW1lIGNvbmZpZ3VyYXRpb24gKHRoZW1lLnhtbCkgZm9yIHRoZW1lIGF0IFwiJHt0aGVtZVhNTFBhdGh9XCJgLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHBhcnNlZFRoZW1lQ29uZmlnID0gcGFyc2VYTUwoc291cmNlLCB7XG4gICAgICAgIGlnbm9yZUF0dHJpYnV0ZXM6IGZhbHNlLFxuICAgICAgICBhdHRyaWJ1dGVOYW1lUHJlZml4OiAnJyxcbiAgICAgICAgaWdub3JlTmFtZVNwYWNlOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgY29uc3QgcGFyZW50ID0gKHBhcnNlZFRoZW1lQ29uZmlnLnRoZW1lLnBhcmVudCBhcyBzdHJpbmcpIHx8ICcnO1xuICAgIHRyYWNlKFxuICAgICAgICBwYXJlbnRcbiAgICAgICAgICAgID8gYGZvdW5kIHBhcmVudCBvZiAke3BhcmVudH0gZm9yIHRoZW1lIGF0ICR7dGhlbWVQYXRofWBcbiAgICAgICAgICAgIDogYG5vIHBhcmVudCBmb3VuZCBmb3IgdGhlbWUgYXQgcGF0aCAke3RoZW1lUGF0aH1gLFxuICAgICk7XG4gICAgcmV0dXJuIHBhcmVudDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RGVwbG95ZWRUaGVtZXNGb3JWZW5kb3IoXG4gICAgbWFnZW50b1Jvb3Q6IHN0cmluZyxcbiAgICBhcmVhOiAnZnJvbnRlbmQnIHwgJ2FkbWluaHRtbCcsXG4gICAgdmVuZG9yOiBzdHJpbmcsXG4pOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgdmVuZG9yUGF0aCA9IGpvaW4obWFnZW50b1Jvb3QsICdwdWInLCAnc3RhdGljJywgYXJlYSwgdmVuZG9yKTtcbiAgICBjb25zdCB2ZW5kb3JFbnRyaWVzID0gYXdhaXQgZ2V0RGlyRW50cmllc0F0UGF0aCh2ZW5kb3JQYXRoKTtcbiAgICBjb25zdCB0aGVtZU5hbWVzID0gdmVuZG9yRW50cmllcy5maWx0ZXIoZSA9PiAvXlthLXpBLVowLTktX10rJC8udGVzdChlKSk7XG5cbiAgICByZXR1cm4gdGhlbWVOYW1lcy5tYXAobmFtZSA9PiBgJHt2ZW5kb3J9LyR7bmFtZX1gKTtcbn1cblxuY29uc3QgZ2V0RGlyRW50cmllc0F0UGF0aCA9IChwYXRoOiBzdHJpbmcpID0+XG4gICAgcmVhZGRpcihwYXRoLCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSlcbiAgICAgICAgLnRoZW4oZW50cmllcyA9PiBlbnRyaWVzLmZpbHRlcihkID0+IGQuaXNEaXJlY3RvcnkoKSkubWFwKGQgPT4gZC5uYW1lKSlcbiAgICAgICAgLmNhdGNoKCgpID0+IFtdIGFzIHN0cmluZ1tdKTtcbiJdfQ==