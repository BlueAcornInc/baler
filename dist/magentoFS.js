"use strict";
/**
 * Copyright Â© Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fsPromises_1 = require("./fsPromises");
const fs_1 = require("fs");
const path_1 = require("path");
const fast_glob_1 = __importDefault(require("fast-glob"));
// @ts-ignore
const glob_1 = __importDefault(require("glob"));
const flatten_1 = require("./flatten");
const fromentries_1 = __importDefault(require("fromentries"));
const fast_xml_parser_1 = require("fast-xml-parser");
const findUp_1 = require("./findUp");
const magentoInterop_1 = require("./magentoInterop");
const BalerError_1 = require("./BalerError");
const trace_1 = require("./trace");
const parseTemplateDeps_1 = require("./parseTemplateDeps");
/**
 * @summary Verify all the dirs we need from Magento are available.
 *          Things to be checked should be kept to the essentials
 *          (see: https://github.com/magento/baler/issues/30)
 */
async function findMagentoRoot(dir) {
    trace_1.trace(`looking for magento root starting at ${dir}`);
    const EXPECTED_ENTRIES = ['app', 'vendor', 'pub'];
    const predicate = (dir, entries) => {
        return EXPECTED_ENTRIES.every(e => entries.includes(e));
    };
    return findUp_1.findUp(dir, predicate);
}
exports.findMagentoRoot = findMagentoRoot;
/**
 * @summary Get a list of names for all enabled modules.
 *          We _could_ use a full PHP parser here to be safe,
 *          but `app/etc/config.php` is codegen'd, so the odds
 *          of it not following very specific conventions is small
 */
async function getEnabledModules(magentoRoot) {
    trace_1.trace('reading enabled modules from app/etc/config.php');
    const configPath = path_1.join(magentoRoot, 'app/etc/config.php');
    const rawConfig = await fsPromises_1.readFile(configPath, 'utf8').catch(() => '');
    if (!rawConfig) {
        throw new BalerError_1.BalerError(`Failed to read list of enabled modules from ${configPath}`);
    }
    let [, rawArrayBody = ''] = rawConfig.match(/'modules'\s*=>\s*\[(.+)\]/s) || [];
    if (!rawArrayBody) {
        rawConfig.match(/'modules'\s*=>\s*array\((.+)\)/s) || [];
    }
    const items = rawArrayBody.split(',').map(t => t.trim());
    const enabledModules = [];
    for (const item of items) {
        const [, name = '', enabledStr = ''] = item.match(/'(\w+)'\s*=>\s*([01])/) || [];
        if (name && Number(enabledStr))
            enabledModules.push(name);
    }
    trace_1.trace(`enabled modules: ${JSON.stringify(enabledModules)}`);
    return enabledModules;
}
exports.getEnabledModules = getEnabledModules;
async function getComponents(magentoRoot) {
    const componentPaths = await magentoInterop_1.getModulesAndThemesFromMagento(magentoRoot);
    return {
        themes: await getThemesFromPaths(componentPaths.themes),
        modules: getModulesFromPaths(componentPaths.modules),
    };
}
exports.getComponents = getComponents;
async function getThemesFromPaths(themePaths) {
    const pendingThemes = Object.entries(themePaths).map(async ([fullID, path]) => {
        const [area, vendor, name] = fullID.split('/');
        const themeID = `${vendor}/${name}`;
        const theme = {
            name,
            vendor,
            area: area,
            themeID,
            path,
            parentID: await getThemeParentName(path),
        };
        return [themeID, theme];
    });
    return fromentries_1.default(await Promise.all(pendingThemes));
}
function getModulesFromPaths(modulePaths) {
    return fromentries_1.default(Object.entries(modulePaths).map(([moduleID, path]) => {
        const mod = {
            moduleID,
            path: path,
        };
        return [moduleID, mod];
    }));
}
/**
 * @summary Get a list of all _deployed_ frontend and adminhtml themes
 *          for all vendors
 */
async function getDeployedThemes(magentoRoot) {
    trace_1.trace('checking pub/static for deployed themes');
    const staticRoot = path_1.join(magentoRoot, 'pub', 'static');
    const [frontendVendors, adminVendors] = await Promise.all([
        getDirEntriesAtPath(path_1.join(staticRoot, 'frontend')),
        getDirEntriesAtPath(path_1.join(staticRoot, 'adminhtml')),
    ]);
    const pendingFrontendThemes = Promise.all(frontendVendors.map(v => getDeployedThemesForVendor(magentoRoot, 'frontend', v)));
    const pendingAdminThemes = Promise.all(adminVendors.map(v => getDeployedThemesForVendor(magentoRoot, 'adminhtml', v)));
    const [frontendThemes, adminThemes] = await Promise.all([
        pendingFrontendThemes,
        pendingAdminThemes,
    ]);
    const deployedThemes = [
        ...flatten_1.flatten(frontendThemes),
        ...flatten_1.flatten(adminThemes),
    ];
    trace_1.trace(`found deployed themes: ${deployedThemes}`);
    return deployedThemes;
}
exports.getDeployedThemes = getDeployedThemes;
/**
 * @summary Get an unordered list of all .phtml files for a specific
 *          area (frontend/adminhtml/base) for enabled modules only
 * @todo Switch from fast-glob to manual recursive crawling of the fs.
 *       Globbing has too much of a perf penalty
 */
async function getPHTMLFilesEligibleForUseWithTheme(themeHierarchy, enabledModules, modules) {
    const moduleGlobs = enabledModules.map(moduleID => {
        const mod = modules[moduleID];
        return path_1.join(mod.path, 'view', `{${themeHierarchy[0].area},base}`, 'templates', '**/*.phtml');
    });
    const themeGlobs = flatten_1.flatten(enabledModules.map(m => {
        return themeHierarchy.map(t => `${t.path}/${m}/templates/**/*.phtml`);
    }));
    return fast_glob_1.default([...moduleGlobs, ...themeGlobs], {
        onlyFiles: true,
    });
}
exports.getPHTMLFilesEligibleForUseWithTheme = getPHTMLFilesEligibleForUseWithTheme;
async function getLayoutFilesEligibleForUseWithTheme(themeHierarchy, enabledModules, modules) {
    const promises = [];
    const globbyCallback = (resolve, reject) => (err, files) => {
        if (err) {
            console.log(err);
            reject(err);
        }
        else {
            console.log(files);
            resolve(files);
        }
    };
    for (const enabledModule of enabledModules) {
        const mod = modules[enabledModule];
        if (mod) {
            promises.push(new Promise((resolve, reject) => {
                glob_1.default(path_1.join(mod.path, 'view', themeHierarchy[0].area, 'layout', '*.xml'), globbyCallback(resolve, reject));
            }));
            promises.push(new Promise((resolve, reject) => {
                glob_1.default(path_1.join(mod.path, 'view', 'base', 'layout', '*.xml'), globbyCallback(resolve, reject));
            }));
            for (const theme of themeHierarchy) {
                promises.push(new Promise((resolve, reject) => {
                    glob_1.default(path_1.join(theme.path, enabledModule, 'layout', '*.xml'), globbyCallback(resolve, reject));
                }));
            }
        }
    }
    const filePaths = await Promise.all(promises);
    let allPaths = [];
    for (const filePathsArray of filePaths) {
        // @ts-ignore
        allPaths = allPaths.concat(filePathsArray);
    }
    return allPaths;
}
exports.getLayoutFilesEligibleForUseWithTheme = getLayoutFilesEligibleForUseWithTheme;
;
async function getPHTMLFilesFromLayoutHandle(layoutFile, themeHierarchy, modules) {
    const templates = [];
    // Read layout file
    const layoutXml = await fsPromises_1.readFile(layoutFile, 'utf8').catch(() => '');
    // Get phtml files
    let matches = layoutXml.match(/template="(.*?)"/g);
    if (matches) {
        const matchesArray = matches.map(match => match.match(/"(.*?)"/));
        for (const match of matchesArray) {
            if (match instanceof Array) {
                templates.push(match[1]);
            }
        }
    }
    // Convert phtml files into file paths
    return templates
        // Fully qualified only
        .filter(template => template.split('::').length > 1)
        // Resolve path
        .map(template => {
        const [moduleName, file] = template.split('::');
        const fallbackPaths = themeHierarchy
            .map(theme => `${theme.path}/${moduleName}/templates/${file}`);
        fallbackPaths.push(`${modules[moduleName].path}/view/${themeHierarchy[0].area}/templates/${file}`);
        fallbackPaths.push(`${modules[moduleName].path}/view/base/templates/${file}`);
        for (const fallback of fallbackPaths) {
            try {
                const found = fs_1.statSync(fallback);
                return fallback;
            }
            catch (err) { }
        }
        return '';
    })
        // Remove templates that we couldn't find
        .filter((template) => template.length > 0);
}
exports.getPHTMLFilesFromLayoutHandle = getPHTMLFilesFromLayoutHandle;
;
async function getDepsFromPHTMLPath(templateFile) {
    const templateContent = await fsPromises_1.readFile(templateFile, 'utf8').catch(() => '');
    const { deps } = parseTemplateDeps_1.parseTemplateDeps(templateContent);
    return deps || [];
}
exports.getDepsFromPHTMLPath = getDepsFromPHTMLPath;
async function getLocalesForDeployedTheme(magentoRoot, theme) {
    trace_1.trace(`fetching deployed locales for ${theme.themeID}`);
    const themeRoot = path_1.join(magentoRoot, getStaticDirForTheme(theme));
    const dirs = await getDirEntriesAtPath(themeRoot);
    // filter out any extra files/folders that aren't locales
    const reLang = /^[a-z]{2}(?:_[a-z]{2})?$/i;
    const locales = dirs.filter(d => reLang.test(d));
    trace_1.trace(`found deployed locales for ${theme.themeID}: ${JSON.stringify(locales)}`);
    return locales;
}
exports.getLocalesForDeployedTheme = getLocalesForDeployedTheme;
function getStaticDirForTheme(theme) {
    // Can't use `vendor` prop from Theme, because the casing
    // might be different. Magento always uses the theme ID when
    // writing to `pub/static`. We have to split here, though,
    // so that *nix path separators don't make it in (need windows compat)
    const [vendor, name] = theme.themeID.split('/');
    return path_1.join('pub', 'static', theme.area, vendor, name);
}
exports.getStaticDirForTheme = getStaticDirForTheme;
async function getThemeParentName(themePath) {
    trace_1.trace(`checking for parent of theme at ${themePath}`);
    const themeXMLPath = path_1.join(themePath, 'theme.xml');
    const source = await fsPromises_1.readFile(themeXMLPath, 'utf8').catch(() => '');
    if (!source) {
        throw new BalerError_1.BalerError(`Could not find theme configuration (theme.xml) for theme at "${themeXMLPath}"`);
    }
    const parsedThemeConfig = fast_xml_parser_1.parse(source, {
        ignoreAttributes: false,
        attributeNamePrefix: '',
        ignoreNameSpace: true,
    });
    const parent = parsedThemeConfig.theme.parent || '';
    trace_1.trace(parent
        ? `found parent of ${parent} for theme at ${themePath}`
        : `no parent found for theme at path ${themePath}`);
    return parent;
}
async function getDeployedThemesForVendor(magentoRoot, area, vendor) {
    const vendorPath = path_1.join(magentoRoot, 'pub', 'static', area, vendor);
    const vendorEntries = await getDirEntriesAtPath(vendorPath);
    const themeNames = vendorEntries.filter(e => /^[a-zA-Z0-9-_]+$/.test(e));
    return themeNames.map(name => `${vendor}/${name}`);
}
const getDirEntriesAtPath = (path) => fsPromises_1.readdir(path, { withFileTypes: true })
    .then(entries => entries.filter(d => d.isDirectory()).map(d => d.name))
    .catch(() => []);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFnZW50b0ZTLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL21hZ2VudG9GUy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7OztBQUVILDZDQUFpRDtBQUNqRCwyQkFBOEI7QUFDOUIsK0JBQTRCO0FBQzVCLDBEQUE2QjtBQUM3QixhQUFhO0FBQ2IsZ0RBQTBDO0FBQzFDLHVDQUFvQztBQUVwQyw4REFBc0M7QUFDdEMscURBQW9EO0FBQ3BELHFDQUFrQztBQUNsQyxxREFBa0U7QUFDbEUsNkNBQTBDO0FBQzFDLG1DQUFnQztBQUNoQywyREFBd0Q7QUFFeEQ7Ozs7R0FJRztBQUNJLEtBQUssVUFBVSxlQUFlLENBQUMsR0FBVztJQUM3QyxhQUFLLENBQUMsd0NBQXdDLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDckQsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDbEQsTUFBTSxTQUFTLEdBQUcsQ0FBQyxHQUFXLEVBQUUsT0FBaUIsRUFBRSxFQUFFO1FBQ2pELE9BQU8sZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzVELENBQUMsQ0FBQztJQUVGLE9BQU8sZUFBTSxDQUFDLEdBQUcsRUFBRSxTQUFTLENBQUMsQ0FBQztBQUNsQyxDQUFDO0FBUkQsMENBUUM7QUFFRDs7Ozs7R0FLRztBQUNJLEtBQUssVUFBVSxpQkFBaUIsQ0FBQyxXQUFtQjtJQUN2RCxhQUFLLENBQUMsaURBQWlELENBQUMsQ0FBQztJQUN6RCxNQUFNLFVBQVUsR0FBRyxXQUFJLENBQUMsV0FBVyxFQUFFLG9CQUFvQixDQUFDLENBQUM7SUFDM0QsTUFBTSxTQUFTLEdBQUcsTUFBTSxxQkFBUSxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFF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YUFBYSxHQUFHLE1BQU0sbUJBQW1CLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDNUQsTUFBTSxVQUFVLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXpFLE9BQU8sVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxJQUFJLElBQUksRUFBRSxDQUFDLENBQUM7QUFDdkQsQ0FBQztBQUVELE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxJQUFZLEVBQUUsRUFBRSxDQUN6QyxvQkFBTyxDQUFDLElBQUksRUFBRSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsQ0FBQztLQUNqQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ3RFLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFjLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IMKpIE1hZ2VudG8sIEluYy4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIFNlZSBDT1BZSU5HLnR4dCBmb3IgbGljZW5zZSBkZXRhaWxzLlxuICovXG5cbmltcG9ydCB7IHJlYWRGaWxlLCByZWFkZGlyIH0gZnJvbSAnLi9mc1Byb21pc2VzJztcbmltcG9ydCB7IHN0YXRTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgam9pbiB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IGdsb2IgZnJvbSAnZmFzdC1nbG9iJztcbi8vIEB0cy1pZ25vcmVcbmltcG9ydCBnbG9iVGhhdFdvcmtzV2l0aENsb3VkIGZyb20gJ2dsb2InO1xuaW1wb3J0IHsgZmxhdHRlbiB9IGZyb20gJy4vZmxhdHRlbic7XG5pbXBvcnQgeyBUaGVtZSwgQ29tcG9uZW50cywgTW9kdWxlLCBDb21wb25lbnRQYXRocyB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IGZyb21FbnRyaWVzIGZyb20gJ2Zyb21lbnRyaWVzJztcbmltcG9ydCB7IHBhcnNlIGFzIHBhcnNlWE1MIH0gZnJvbSAnZmFzdC14bWwtcGFyc2VyJztcbmltcG9ydCB7IGZpbmRVcCB9IGZyb20gJy4vZmluZFVwJztcbmltcG9ydCB7IGdldE1vZHVsZXNBbmRUaGVtZXNGcm9tTWFnZW50byB9IGZyb20gJy4vbWFnZW50b0ludGVyb3AnO1xuaW1wb3J0IHsgQmFsZXJFcnJvciB9IGZyb20gJy4vQmFsZXJFcnJvcic7XG5pbXBvcnQgeyB0cmFjZSB9IGZyb20gJy4vdHJhY2UnO1xuaW1wb3J0IHsgcGFyc2VUZW1wbGF0ZURlcHMgfSBmcm9tICcuL3BhcnNlVGVtcGxhdGVEZXBzJztcblxuLyoqXG4gKiBAc3VtbWFyeSBWZXJpZnkgYWxsIHRoZSBkaXJzIHdlIG5lZWQgZnJvbSBNYWdlbnRvIGFyZSBhdmFpbGFibGUuXG4gKiAgICAgICAgICBUaGluZ3MgdG8gYmUgY2hlY2tlZCBzaG91bGQgYmUga2VwdCB0byB0aGUgZXNzZW50aWFsc1xuICogICAgICAgICAgKHNlZTogaHR0cHM6Ly9naXRodWIuY29tL21hZ2VudG8vYmFsZXIvaXNzdWVzLzMwKVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZmluZE1hZ2VudG9Sb290KGRpcjogc3RyaW5nKSB7XG4gICAgdHJhY2UoYGxvb2tpbmcgZm9yIG1hZ2VudG8gcm9vdCBzdGFydGluZyBhdCAke2Rpcn1gKTtcbiAgICBjb25zdCBFWFBFQ1RFRF9FTlRSSUVTID0gWydhcHAnLCAndmVuZG9yJywgJ3B1YiddO1xuICAgIGNvbnN0IHByZWRpY2F0ZSA9IChkaXI6IHN0cmluZywgZW50cmllczogc3RyaW5nW10pID0+IHtcbiAgICAgICAgcmV0dXJuIEVYUEVDVEVEX0VOVFJJRVMuZXZlcnkoZSA9PiBlbnRyaWVzLmluY2x1ZGVzKGUpKTtcbiAgICB9O1xuXG4gICAgcmV0dXJuIGZpbmRVcChkaXIsIHByZWRpY2F0ZSk7XG59XG5cbi8qKlxuICogQHN1bW1hcnkgR2V0IGEgbGlzdCBvZiBuYW1lcyBmb3IgYWxsIGVuYWJsZWQgbW9kdWxlcy5cbiAqICAgICAgICAgIFdlIF9jb3VsZF8gdXNlIGEgZnVsbCBQSFAgcGFyc2VyIGhlcmUgdG8gYmUgc2FmZSxcbiAqICAgICAgICAgIGJ1dCBgYXBwL2V0Yy9jb25maWcucGhwYCBpcyBjb2RlZ2VuJ2QsIHNvIHRoZSBvZGRzXG4gKiAgICAgICAgICBvZiBpdCBub3QgZm9sbG93aW5nIHZlcnkgc3BlY2lmaWMgY29udmVudGlvbnMgaXMgc21hbGxcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEVuYWJsZWRNb2R1bGVzKG1hZ2VudG9Sb290OiBzdHJpbmcpIHtcbiAgICB0cmFjZSgncmVhZGluZyBlbmFibGVkIG1vZHVsZXMgZnJvbSBhcHAvZXRjL2NvbmZpZy5waHAnKTtcbiAgICBjb25zdCBjb25maWdQYXRoID0gam9pbihtYWdlbnRvUm9vdCwgJ2FwcC9ldGMvY29uZmlnLnBocCcpO1xuICAgIGNvbnN0IHJhd0NvbmZpZyA9IGF3YWl0IHJlYWRGaWxlKGNvbmZpZ1BhdGgsICd1dGY4JykuY2F0Y2goKCkgPT4gJycpO1xuICAgIGlmICghcmF3Q29uZmlnKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWxlckVycm9yKFxuICAgICAgICAgICAgYEZhaWxlZCB0byByZWFkIGxpc3Qgb2YgZW5hYmxlZCBtb2R1bGVzIGZyb20gJHtjb25maWdQYXRofWAsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgbGV0IFssIHJhd0FycmF5Qm9keSA9ICcnXSA9XG4gICAgICAgIHJhd0NvbmZpZy5tYXRjaCgvJ21vZHVsZXMnXFxzKj0+XFxzKlxcWyguKylcXF0vcykgfHwgW107XG4gICAgaWYgKCFyYXdBcnJheUJvZHkpIHtcbiAgICAgICAgcmF3Q29uZmlnLm1hdGNoKC8nbW9kdWxlcydcXHMqPT5cXHMqYXJyYXlcXCgoLispXFwpL3MpIHx8IFtdO1xuICAgIH1cbiAgICBjb25zdCBpdGVtcyA9IHJhd0FycmF5Qm9keS5zcGxpdCgnLCcpLm1hcCh0ID0+IHQudHJpbSgpKTtcblxuICAgIGNvbnN0IGVuYWJsZWRNb2R1bGVzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcykge1xuICAgICAgICBjb25zdCBbLCBuYW1lID0gJycsIGVuYWJsZWRTdHIgPSAnJ10gPVxuICAgICAgICAgICAgaXRlbS5tYXRjaCgvJyhcXHcrKSdcXHMqPT5cXHMqKFswMV0pLykgfHwgW107XG4gICAgICAgIGlmIChuYW1lICYmIE51bWJlcihlbmFibGVkU3RyKSkgZW5hYmxlZE1vZHVsZXMucHVzaChuYW1lKTtcbiAgICB9XG5cbiAgICB0cmFjZShgZW5hYmxlZCBtb2R1bGVzOiAke0pTT04uc3RyaW5naWZ5KGVuYWJsZWRNb2R1bGVzKX1gKTtcbiAgICByZXR1cm4gZW5hYmxlZE1vZHVsZXM7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRDb21wb25lbnRzKG1hZ2VudG9Sb290OiBzdHJpbmcpOiBQcm9taXNlPENvbXBvbmVudHM+IHtcbiAgICBjb25zdCBjb21wb25lbnRQYXRocyA9IGF3YWl0IGdldE1vZHVsZXNBbmRUaGVtZXNGcm9tTWFnZW50byhtYWdlbnRvUm9vdCk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdGhlbWVzOiBhd2FpdCBnZXRUaGVtZXNGcm9tUGF0aHMoY29tcG9uZW50UGF0aHMudGhlbWVzKSxcbiAgICAgICAgbW9kdWxlczogZ2V0TW9kdWxlc0Zyb21QYXRocyhjb21wb25lbnRQYXRocy5tb2R1bGVzKSxcbiAgICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRUaGVtZXNGcm9tUGF0aHMoXG4gICAgdGhlbWVQYXRoczogQ29tcG9uZW50UGF0aHNbJ3RoZW1lcyddLFxuKTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCBUaGVtZT4+IHtcbiAgICBjb25zdCBwZW5kaW5nVGhlbWVzOiBQcm9taXNlPFtzdHJpbmcsIFRoZW1lXT5bXSA9IE9iamVjdC5lbnRyaWVzKFxuICAgICAgICB0aGVtZVBhdGhzLFxuICAgICkubWFwKGFzeW5jIChbZnVsbElELCBwYXRoXSkgPT4ge1xuICAgICAgICBjb25zdCBbYXJlYSwgdmVuZG9yLCBuYW1lXSA9IGZ1bGxJRC5zcGxpdCgnLycpO1xuICAgICAgICBjb25zdCB0aGVtZUlEID0gYCR7dmVuZG9yfS8ke25hbWV9YDtcbiAgICAgICAgY29uc3QgdGhlbWU6IFRoZW1lID0ge1xuICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgIHZlbmRvcixcbiAgICAgICAgICAgIGFyZWE6IGFyZWEgYXMgVGhlbWVbJ2FyZWEnXSxcbiAgICAgICAgICAgIHRoZW1lSUQsXG4gICAgICAgICAgICBwYXRoLFxuICAgICAgICAgICAgcGFyZW50SUQ6IGF3YWl0IGdldFRoZW1lUGFyZW50TmFtZShwYXRoKSxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIFt0aGVtZUlELCB0aGVtZV0gYXMgW3N0cmluZywgVGhlbWVdO1xuICAgIH0pO1xuICAgIHJldHVybiBmcm9tRW50cmllcyhhd2FpdCBQcm9taXNlLmFsbChwZW5kaW5nVGhlbWVzKSk7XG59XG5cbmZ1bmN0aW9uIGdldE1vZHVsZXNGcm9tUGF0aHMoXG4gICAgbW9kdWxlUGF0aHM6IENvbXBvbmVudFBhdGhzWydtb2R1bGVzJ10sXG4pOiBSZWNvcmQ8c3RyaW5nLCBNb2R1bGU+IHtcbiAgICByZXR1cm4gZnJvbUVudHJpZXMoXG4gICAgICAgIE9iamVjdC5lbnRyaWVzKG1vZHVsZVBhdGhzKS5tYXAoKFttb2R1bGVJRCwgcGF0aF0pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1vZDogTW9kdWxlID0ge1xuICAgICAgICAgICAgICAgIG1vZHVsZUlELFxuICAgICAgICAgICAgICAgIHBhdGg6IHBhdGgsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmV0dXJuIFttb2R1bGVJRCwgbW9kXSBhcyBbc3RyaW5nLCBNb2R1bGVdO1xuICAgICAgICB9KSxcbiAgICApO1xufVxuXG4vKipcbiAqIEBzdW1tYXJ5IEdldCBhIGxpc3Qgb2YgYWxsIF9kZXBsb3llZF8gZnJvbnRlbmQgYW5kIGFkbWluaHRtbCB0aGVtZXNcbiAqICAgICAgICAgIGZvciBhbGwgdmVuZG9yc1xuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RGVwbG95ZWRUaGVtZXMoXG4gICAgbWFnZW50b1Jvb3Q6IHN0cmluZyxcbik6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICB0cmFjZSgnY2hlY2tpbmcgcHViL3N0YXRpYyBmb3IgZGVwbG95ZWQgdGhlbWVzJyk7XG4gICAgY29uc3Qgc3RhdGljUm9vdCA9IGpvaW4obWFnZW50b1Jvb3QsICdwdWInLCAnc3RhdGljJyk7XG5cbiAgICBjb25zdCBbZnJvbnRlbmRWZW5kb3JzLCBhZG1pblZlbmRvcnNdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICBnZXREaXJFbnRyaWVzQXRQYXRoKGpvaW4oc3RhdGljUm9vdCwgJ2Zyb250ZW5kJykpLFxuICAgICAgICBnZXREaXJFbnRyaWVzQXRQYXRoKGpvaW4oc3RhdGljUm9vdCwgJ2FkbWluaHRtbCcpKSxcbiAgICBdKTtcblxuICAgIGNvbnN0IHBlbmRpbmdGcm9udGVuZFRoZW1lcyA9IFByb21pc2UuYWxsKFxuICAgICAgICBmcm9udGVuZFZlbmRvcnMubWFwKHYgPT5cbiAgICAgICAgICAgIGdldERlcGxveWVkVGhlbWVzRm9yVmVuZG9yKG1hZ2VudG9Sb290LCAnZnJvbnRlbmQnLCB2KSxcbiAgICAgICAgKSxcbiAgICApO1xuICAgIGNvbnN0IHBlbmRpbmdBZG1pblRoZW1lcyA9IFByb21pc2UuYWxsKFxuICAgICAgICBhZG1pblZlbmRvcnMubWFwKHYgPT5cbiAgICAgICAgICAgIGdldERlcGxveWVkVGhlbWVzRm9yVmVuZG9yKG1hZ2VudG9Sb290LCAnYWRtaW5odG1sJywgdiksXG4gICAgICAgICksXG4gICAgKTtcblxuICAgIGNvbnN0IFtmcm9udGVuZFRoZW1lcywgYWRtaW5UaGVtZXNdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICBwZW5kaW5nRnJvbnRlbmRUaGVtZXMsXG4gICAgICAgIHBlbmRpbmdBZG1pblRoZW1lcyxcbiAgICBdKTtcblxuICAgIGNvbnN0IGRlcGxveWVkVGhlbWVzID0gW1xuICAgICAgICAuLi5mbGF0dGVuKGZyb250ZW5kVGhlbWVzKSxcbiAgICAgICAgLi4uZmxhdHRlbihhZG1pblRoZW1lcyksXG4gICAgXTtcbiAgICB0cmFjZShgZm91bmQgZGVwbG95ZWQgdGhlbWVzOiAke2RlcGxveWVkVGhlbWVzfWApO1xuICAgIHJldHVybiBkZXBsb3llZFRoZW1lcztcbn1cblxuLyoqXG4gKiBAc3VtbWFyeSBHZXQgYW4gdW5vcmRlcmVkIGxpc3Qgb2YgYWxsIC5waHRtbCBmaWxlcyBmb3IgYSBzcGVjaWZpY1xuICogICAgICAgICAgYXJlYSAoZnJvbnRlbmQvYWRtaW5odG1sL2Jhc2UpIGZvciBlbmFibGVkIG1vZHVsZXMgb25seVxuICogQHRvZG8gU3dpdGNoIGZyb20gZmFzdC1nbG9iIHRvIG1hbnVhbCByZWN1cnNpdmUgY3Jhd2xpbmcgb2YgdGhlIGZzLlxuICogICAgICAgR2xvYmJpbmcgaGFzIHRvbyBtdWNoIG9mIGEgcGVyZiBwZW5hbHR5XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRQSFRNTEZpbGVzRWxpZ2libGVGb3JVc2VXaXRoVGhlbWUoXG4gICAgdGhlbWVIaWVyYXJjaHk6IFRoZW1lW10sXG4gICAgZW5hYmxlZE1vZHVsZXM6IHN0cmluZ1tdLFxuICAgIG1vZHVsZXM6IFJlY29yZDxzdHJpbmcsIE1vZHVsZT4sXG4pOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgbW9kdWxlR2xvYnMgPSBlbmFibGVkTW9kdWxlcy5tYXAobW9kdWxlSUQgPT4ge1xuICAgICAgICBjb25zdCBtb2QgPSBtb2R1bGVzW21vZHVsZUlEXTtcbiAgICAgICAgcmV0dXJuIGpvaW4oXG4gICAgICAgICAgICBtb2QucGF0aCxcbiAgICAgICAgICAgICd2aWV3JyxcbiAgICAgICAgICAgIGB7JHt0aGVtZUhpZXJhcmNoeVswXS5hcmVhfSxiYXNlfWAsXG4gICAgICAgICAgICAndGVtcGxhdGVzJyxcbiAgICAgICAgICAgICcqKi8qLnBodG1sJyxcbiAgICAgICAgKTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHRoZW1lR2xvYnMgPSBmbGF0dGVuKFxuICAgICAgICBlbmFibGVkTW9kdWxlcy5tYXAobSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhlbWVIaWVyYXJjaHkubWFwKFxuICAgICAgICAgICAgICAgIHQgPT4gYCR7dC5wYXRofS8ke219L3RlbXBsYXRlcy8qKi8qLnBodG1sYCxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pLFxuICAgICk7XG5cbiAgICByZXR1cm4gZ2xvYihbLi4ubW9kdWxlR2xvYnMsIC4uLnRoZW1lR2xvYnNdLCB7XG4gICAgICAgIG9ubHlGaWxlczogdHJ1ZSxcbiAgICB9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldExheW91dEZpbGVzRWxpZ2libGVGb3JVc2VXaXRoVGhlbWUoXG4gICAgdGhlbWVIaWVyYXJjaHk6IFRoZW1lW10sXG4gICAgZW5hYmxlZE1vZHVsZXM6IHN0cmluZ1tdLFxuICAgIG1vZHVsZXM6IFJlY29yZDxzdHJpbmcsIE1vZHVsZT4sXG4pIHtcbiAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xuXG4gICAgY29uc3QgZ2xvYmJ5Q2FsbGJhY2sgPSAocmVzb2x2ZTogRnVuY3Rpb24sIHJlamVjdDogRnVuY3Rpb24pID0+IChlcnI6IHN0cmluZywgZmlsZXM6IHN0cmluZ1tdKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGZpbGVzKTtcbiAgICAgICAgICAgIHJlc29sdmUoZmlsZXMpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIGZvciAoY29uc3QgZW5hYmxlZE1vZHVsZSBvZiBlbmFibGVkTW9kdWxlcykge1xuICAgICAgICBjb25zdCBtb2QgPSBtb2R1bGVzW2VuYWJsZWRNb2R1bGVdO1xuICAgICAgICBpZiAobW9kKSB7XG4gICAgICAgICAgICBwcm9taXNlcy5wdXNoKFxuICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZ2xvYlRoYXRXb3Jrc1dpdGhDbG91ZChcbiAgICAgICAgICAgICAgICAgICAgICAgIGpvaW4oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kLnBhdGgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3ZpZXcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZW1lSGllcmFyY2h5WzBdLmFyZWEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xheW91dCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJyoueG1sJ1xuICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JieUNhbGxiYWNrKHJlc29sdmUsIHJlamVjdClcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBwcm9taXNlcy5wdXNoKFxuICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZ2xvYlRoYXRXb3Jrc1dpdGhDbG91ZChcbiAgICAgICAgICAgICAgICAgICAgICAgIGpvaW4oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kLnBhdGgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3ZpZXcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdiYXNlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGF5b3V0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnKi54bWwnXG4gICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmJ5Q2FsbGJhY2socmVzb2x2ZSwgcmVqZWN0KVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIClcblxuICAgICAgICAgICAgZm9yIChjb25zdCB0aGVtZSBvZiB0aGVtZUhpZXJhcmNoeSkge1xuICAgICAgICAgICAgICAgIHByb21pc2VzLnB1c2goXG4gICAgICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JUaGF0V29ya3NXaXRoQ2xvdWQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgam9pbihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlbWUucGF0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5hYmxlZE1vZHVsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xheW91dCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcqLnhtbCdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JieUNhbGxiYWNrKHJlc29sdmUsIHJlamVjdClcbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgZmlsZVBhdGhzID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgIGxldCBhbGxQYXRoczogc3RyaW5nW10gPSBbXTtcblxuICAgIGZvciAoY29uc3QgZmlsZVBhdGhzQXJyYXkgb2YgZmlsZVBhdGhzKSB7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgYWxsUGF0aHMgPSBhbGxQYXRocy5jb25jYXQoZmlsZVBhdGhzQXJyYXkpO1xuICAgIH1cblxuICAgIHJldHVybiBhbGxQYXRocztcbn07XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRQSFRNTEZpbGVzRnJvbUxheW91dEhhbmRsZShcbiAgICBsYXlvdXRGaWxlOiBzdHJpbmcsXG4gICAgdGhlbWVIaWVyYXJjaHk6IFRoZW1lW10sXG4gICAgbW9kdWxlczogUmVjb3JkPHN0cmluZywgTW9kdWxlPlxuKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IHRlbXBsYXRlcyA9IFtdO1xuICAgIC8vIFJlYWQgbGF5b3V0IGZpbGVcbiAgICBjb25zdCBsYXlvdXRYbWwgPSBhd2FpdCByZWFkRmlsZShsYXlvdXRGaWxlLCAndXRmOCcpLmNhdGNoKCgpID0+ICcnKTtcbiAgICAvLyBHZXQgcGh0bWwgZmlsZXNcbiAgICBsZXQgbWF0Y2hlcyA9IGxheW91dFhtbC5tYXRjaCgvdGVtcGxhdGU9XCIoLio/KVwiL2cpO1xuICAgIGlmIChtYXRjaGVzKSB7XG4gICAgICAgIGNvbnN0IG1hdGNoZXNBcnJheSA9IG1hdGNoZXMubWFwKG1hdGNoID0+IG1hdGNoLm1hdGNoKC9cIiguKj8pXCIvKSk7XG4gICAgICAgIGZvciAoY29uc3QgbWF0Y2ggb2YgbWF0Y2hlc0FycmF5KSB7XG4gICAgICAgICAgICBpZiAobWF0Y2ggaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlcy5wdXNoKG1hdGNoWzFdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICAvLyBDb252ZXJ0IHBodG1sIGZpbGVzIGludG8gZmlsZSBwYXRoc1xuICAgIHJldHVybiB0ZW1wbGF0ZXNcbiAgICAgICAgLy8gRnVsbHkgcXVhbGlmaWVkIG9ubHlcbiAgICAgICAgLmZpbHRlcih0ZW1wbGF0ZSA9PiB0ZW1wbGF0ZS5zcGxpdCgnOjonKS5sZW5ndGggPiAxKVxuICAgICAgICAvLyBSZXNvbHZlIHBhdGhcbiAgICAgICAgLm1hcCh0ZW1wbGF0ZSA9PiB7XG4gICAgICAgICAgICBjb25zdCBbbW9kdWxlTmFtZSwgZmlsZV0gPSB0ZW1wbGF0ZS5zcGxpdCgnOjonKTtcbiAgICAgICAgICAgIGNvbnN0IGZhbGxiYWNrUGF0aHMgPSB0aGVtZUhpZXJhcmNoeVxuICAgICAgICAgICAgICAgIC5tYXAodGhlbWUgPT4gYCR7dGhlbWUucGF0aH0vJHttb2R1bGVOYW1lfS90ZW1wbGF0ZXMvJHtmaWxlfWApO1xuICAgICAgICAgICAgZmFsbGJhY2tQYXRocy5wdXNoKGAke21vZHVsZXNbbW9kdWxlTmFtZV0ucGF0aH0vdmlldy8ke3RoZW1lSGllcmFyY2h5WzBdLmFyZWF9L3RlbXBsYXRlcy8ke2ZpbGV9YCk7XG4gICAgICAgICAgICBmYWxsYmFja1BhdGhzLnB1c2goYCR7bW9kdWxlc1ttb2R1bGVOYW1lXS5wYXRofS92aWV3L2Jhc2UvdGVtcGxhdGVzLyR7ZmlsZX1gKTtcblxuICAgICAgICAgICAgZm9yIChjb25zdCBmYWxsYmFjayBvZiBmYWxsYmFja1BhdGhzKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm91bmQgPSBzdGF0U3luYyhmYWxsYmFjayk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxsYmFjaztcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHt9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiAnJ1xuICAgICAgICB9KVxuICAgICAgICAvLyBSZW1vdmUgdGVtcGxhdGVzIHRoYXQgd2UgY291bGRuJ3QgZmluZFxuICAgICAgICAuZmlsdGVyKCh0ZW1wbGF0ZSkgPT4gdGVtcGxhdGUubGVuZ3RoID4gMCk7XG59O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0RGVwc0Zyb21QSFRNTFBhdGgoXG4gICAgdGVtcGxhdGVGaWxlOiBzdHJpbmdcbik6IFByb21pc2U8c3RyaW5nW10+IHtcbiAgICBjb25zdCB0ZW1wbGF0ZUNvbnRlbnQgPSBhd2FpdCByZWFkRmlsZSh0ZW1wbGF0ZUZpbGUsICd1dGY4JykuY2F0Y2goKCkgPT4gJycpO1xuICAgIGNvbnN0IHsgZGVwcyB9ID0gcGFyc2VUZW1wbGF0ZURlcHModGVtcGxhdGVDb250ZW50KTtcblxuICAgIHJldHVybiBkZXBzIHx8IFtdO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0TG9jYWxlc0ZvckRlcGxveWVkVGhlbWUoXG4gICAgbWFnZW50b1Jvb3Q6IHN0cmluZyxcbiAgICB0aGVtZTogVGhlbWUsXG4pOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgdHJhY2UoYGZldGNoaW5nIGRlcGxveWVkIGxvY2FsZXMgZm9yICR7dGhlbWUudGhlbWVJRH1gKTtcbiAgICBjb25zdCB0aGVtZVJvb3QgPSBqb2luKG1hZ2VudG9Sb290LCBnZXRTdGF0aWNEaXJGb3JUaGVtZSh0aGVtZSkpO1xuICAgIGNvbnN0IGRpcnMgPSBhd2FpdCBnZXREaXJFbnRyaWVzQXRQYXRoKHRoZW1lUm9vdCk7XG5cbiAgICAvLyBmaWx0ZXIgb3V0IGFueSBleHRyYSBmaWxlcy9mb2xkZXJzIHRoYXQgYXJlbid0IGxvY2FsZXNcbiAgICBjb25zdCByZUxhbmcgPSAvXlthLXpdezJ9KD86X1thLXpdezJ9KT8kL2k7XG4gICAgY29uc3QgbG9jYWxlcyA9IGRpcnMuZmlsdGVyKGQgPT4gcmVMYW5nLnRlc3QoZCkpO1xuICAgIHRyYWNlKFxuICAgICAgICBgZm91bmQgZGVwbG95ZWQgbG9jYWxlcyBmb3IgJHt0aGVtZS50aGVtZUlEfTogJHtKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgIGxvY2FsZXMsXG4gICAgICAgICl9YCxcbiAgICApO1xuICAgIHJldHVybiBsb2NhbGVzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U3RhdGljRGlyRm9yVGhlbWUodGhlbWU6IFRoZW1lKSB7XG4gICAgLy8gQ2FuJ3QgdXNlIGB2ZW5kb3JgIHByb3AgZnJvbSBUaGVtZSwgYmVjYXVzZSB0aGUgY2FzaW5nXG4gICAgLy8gbWlnaHQgYmUgZGlmZmVyZW50LiBNYWdlbnRvIGFsd2F5cyB1c2VzIHRoZSB0aGVtZSBJRCB3aGVuXG4gICAgLy8gd3JpdGluZyB0byBgcHViL3N0YXRpY2AuIFdlIGhhdmUgdG8gc3BsaXQgaGVyZSwgdGhvdWdoLFxuICAgIC8vIHNvIHRoYXQgKm5peCBwYXRoIHNlcGFyYXRvcnMgZG9uJ3QgbWFrZSBpdCBpbiAobmVlZCB3aW5kb3dzIGNvbXBhdClcbiAgICBjb25zdCBbdmVuZG9yLCBuYW1lXSA9IHRoZW1lLnRoZW1lSUQuc3BsaXQoJy8nKTtcbiAgICByZXR1cm4gam9pbigncHViJywgJ3N0YXRpYycsIHRoZW1lLmFyZWEsIHZlbmRvciwgbmFtZSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFRoZW1lUGFyZW50TmFtZSh0aGVtZVBhdGg6IHN0cmluZykge1xuICAgIHRyYWNlKGBjaGVja2luZyBmb3IgcGFyZW50IG9mIHRoZW1lIGF0ICR7dGhlbWVQYXRofWApO1xuICAgIGNvbnN0IHRoZW1lWE1MUGF0aCA9IGpvaW4odGhlbWVQYXRoLCAndGhlbWUueG1sJyk7XG4gICAgY29uc3Qgc291cmNlID0gYXdhaXQgcmVhZEZpbGUodGhlbWVYTUxQYXRoLCAndXRmOCcpLmNhdGNoKCgpID0+ICcnKTtcbiAgICBpZiAoIXNvdXJjZSkge1xuICAgICAgICB0aHJvdyBuZXcgQmFsZXJFcnJvcihcbiAgICAgICAgICAgIGBDb3VsZCBub3QgZmluZCB0aGVtZSBjb25maWd1cmF0aW9uICh0aGVtZS54bWwpIGZvciB0aGVtZSBhdCBcIiR7dGhlbWVYTUxQYXRofVwiYCxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBwYXJzZWRUaGVtZUNvbmZpZyA9IHBhcnNlWE1MKHNvdXJjZSwge1xuICAgICAgICBpZ25vcmVBdHRyaWJ1dGVzOiBmYWxzZSxcbiAgICAgICAgYXR0cmlidXRlTmFtZVByZWZpeDogJycsXG4gICAgICAgIGlnbm9yZU5hbWVTcGFjZTogdHJ1ZSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHBhcmVudCA9IChwYXJzZWRUaGVtZUNvbmZpZy50aGVtZS5wYXJlbnQgYXMgc3RyaW5nKSB8fCAnJztcbiAgICB0cmFjZShcbiAgICAgICAgcGFyZW50XG4gICAgICAgICAgICA/IGBmb3VuZCBwYXJlbnQgb2YgJHtwYXJlbnR9IGZvciB0aGVtZSBhdCAke3RoZW1lUGF0aH1gXG4gICAgICAgICAgICA6IGBubyBwYXJlbnQgZm91bmQgZm9yIHRoZW1lIGF0IHBhdGggJHt0aGVtZVBhdGh9YCxcbiAgICApO1xuICAgIHJldHVybiBwYXJlbnQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldERlcGxveWVkVGhlbWVzRm9yVmVuZG9yKFxuICAgIG1hZ2VudG9Sb290OiBzdHJpbmcsXG4gICAgYXJlYTogJ2Zyb250ZW5kJyB8ICdhZG1pbmh0bWwnLFxuICAgIHZlbmRvcjogc3RyaW5nLFxuKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IHZlbmRvclBhdGggPSBqb2luKG1hZ2VudG9Sb290LCAncHViJywgJ3N0YXRpYycsIGFyZWEsIHZlbmRvcik7XG4gICAgY29uc3QgdmVuZG9yRW50cmllcyA9IGF3YWl0IGdldERpckVudHJpZXNBdFBhdGgodmVuZG9yUGF0aCk7XG4gICAgY29uc3QgdGhlbWVOYW1lcyA9IHZlbmRvckVudHJpZXMuZmlsdGVyKGUgPT4gL15bYS16QS1aMC05LV9dKyQvLnRlc3QoZSkpO1xuXG4gICAgcmV0dXJuIHRoZW1lTmFtZXMubWFwKG5hbWUgPT4gYCR7dmVuZG9yfS8ke25hbWV9YCk7XG59XG5cbmNvbnN0IGdldERpckVudHJpZXNBdFBhdGggPSAocGF0aDogc3RyaW5nKSA9PlxuICAgIHJlYWRkaXIocGF0aCwgeyB3aXRoRmlsZVR5cGVzOiB0cnVlIH0pXG4gICAgICAgIC50aGVuKGVudHJpZXMgPT4gZW50cmllcy5maWx0ZXIoZCA9PiBkLmlzRGlyZWN0b3J5KCkpLm1hcChkID0+IGQubmFtZSkpXG4gICAgICAgIC5jYXRjaCgoKSA9PiBbXSBhcyBzdHJpbmdbXSk7XG4iXX0=